<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>CedarBackup3.cli &#8212; Cedar Backup v3  documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="Cedar Backup v3  documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Cedar Backup v3  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for CedarBackup3.cli</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: iso-8859-1 -*-</span>
<span class="c1"># vim: set ft=python ts=3 sw=3 expandtab:</span>
<span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
<span class="c1">#</span>
<span class="c1">#              C E D A R</span>
<span class="c1">#          S O L U T I O N S       &quot;Software done right.&quot;</span>
<span class="c1">#           S O F T W A R E</span>
<span class="c1">#</span>
<span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2004-2007,2010,2015 Kenneth J. Pronovici.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This program is free software; you can redistribute it and/or</span>
<span class="c1"># modify it under the terms of the GNU General Public License,</span>
<span class="c1"># Version 2, as published by the Free Software Foundation.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="c1">#</span>
<span class="c1"># Copies of the GNU General Public License are available from</span>
<span class="c1"># the Free Software Foundation website, http://www.gnu.org/.</span>
<span class="c1">#</span>
<span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
<span class="c1">#</span>
<span class="c1"># Author   : Kenneth J. Pronovici &lt;pronovic@ieee.org&gt;</span>
<span class="c1"># Language : Python 3 (&gt;= 3.4)</span>
<span class="c1"># Project  : Cedar Backup, release 3</span>
<span class="c1"># Purpose  : Provides command-line interface implementation.</span>
<span class="c1">#</span>
<span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

<span class="c1">########################################################################</span>
<span class="c1"># Module documentation</span>
<span class="c1">########################################################################</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Provides command-line interface implementation for the cback3 script.</span>

<span class="sd">Summary</span>
<span class="sd">=======</span>

<span class="sd">   The functionality in this module encapsulates the command-line interface for</span>
<span class="sd">   the cback3 script.  The cback3 script itself is very short, basically just an</span>
<span class="sd">   invokation of one function implemented here.  That, in turn, makes it</span>
<span class="sd">   simpler to validate the command line interface (for instance, it&#39;s easier to</span>
<span class="sd">   run pychecker against a module, and unit tests are easier, too).</span>

<span class="sd">   The objects and functions implemented in this module are probably not useful</span>
<span class="sd">   to any code external to Cedar Backup.   Anyone else implementing their own</span>
<span class="sd">   command-line interface would have to reimplement (or at least enhance) all</span>
<span class="sd">   of this anyway.</span>

<span class="sd">Backwards Compatibility</span>
<span class="sd">=======================</span>

<span class="sd">   The command line interface has changed between Cedar Backup 1.x and Cedar</span>
<span class="sd">   Backup 2.x.  Some new switches have been added, and the actions have become</span>
<span class="sd">   simple arguments rather than switches (which is a much more standard command</span>
<span class="sd">   line format).  Old 1.x command lines are generally no longer valid.</span>

<span class="sd">Module Attributes</span>
<span class="sd">=================</span>

<span class="sd">Attributes:</span>
<span class="sd">   DEFAULT_CONFIG: The default configuration file</span>
<span class="sd">   DEFAULT_LOGFILE: The default log file path</span>
<span class="sd">   DEFAULT_OWNERSHIP: Default ownership for the logfile</span>
<span class="sd">   DEFAULT_MODE: Default file permissions mode on the logfile</span>
<span class="sd">   VALID_ACTIONS: List of valid actions</span>
<span class="sd">   COMBINE_ACTIONS: List of actions which can be combined with other actions</span>
<span class="sd">   NONCOMBINE_ACTIONS: List of actions which cannot be combined with other actions</span>

<span class="sd">:author: Kenneth J. Pronovici &lt;pronovic@ieee.org&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">########################################################################</span>
<span class="c1"># Imported modules</span>
<span class="c1">########################################################################</span>

<span class="c1"># System modules</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">getopt</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">total_ordering</span>

<span class="c1"># Cedar Backup modules</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.release</span> <span class="k">import</span> <span class="n">AUTHOR</span><span class="p">,</span> <span class="n">EMAIL</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span> <span class="n">DATE</span><span class="p">,</span> <span class="n">COPYRIGHT</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.customize</span> <span class="k">import</span> <span class="n">customizeOverrides</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.util</span> <span class="k">import</span> <span class="n">DirectedGraph</span><span class="p">,</span> <span class="n">PathResolverSingleton</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.util</span> <span class="k">import</span> <span class="n">sortDict</span><span class="p">,</span> <span class="n">splitCommandLine</span><span class="p">,</span> <span class="n">executeCommand</span><span class="p">,</span> <span class="n">getFunctionReference</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.util</span> <span class="k">import</span> <span class="n">getUidGid</span><span class="p">,</span> <span class="n">encodePath</span><span class="p">,</span> <span class="n">Diagnostics</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.config</span> <span class="k">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.peer</span> <span class="k">import</span> <span class="n">RemotePeer</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.actions.collect</span> <span class="k">import</span> <span class="n">executeCollect</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.actions.stage</span> <span class="k">import</span> <span class="n">executeStage</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.actions.store</span> <span class="k">import</span> <span class="n">executeStore</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.actions.purge</span> <span class="k">import</span> <span class="n">executePurge</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.actions.rebuild</span> <span class="k">import</span> <span class="n">executeRebuild</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.actions.validate</span> <span class="k">import</span> <span class="n">executeValidate</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.actions.initialize</span> <span class="k">import</span> <span class="n">executeInitialize</span>


<span class="c1">########################################################################</span>
<span class="c1"># Module-wide constants and variables</span>
<span class="c1">########################################################################</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;CedarBackup3.log.cli&quot;</span><span class="p">)</span>

<span class="n">DISK_LOG_FORMAT</span>    <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> --&gt; [</span><span class="si">%(levelname)-7s</span><span class="s2">] </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
<span class="n">DISK_OUTPUT_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(message)s</span><span class="s2">&quot;</span>
<span class="n">SCREEN_LOG_FORMAT</span>  <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(message)s</span><span class="s2">&quot;</span>
<span class="n">SCREEN_LOG_STREAM</span>  <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
<span class="n">DATE_FORMAT</span>        <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S %Z&quot;</span>

<span class="n">DEFAULT_CONFIG</span>     <span class="o">=</span> <span class="s2">&quot;/etc/cback3.conf&quot;</span>
<span class="n">DEFAULT_LOGFILE</span>    <span class="o">=</span> <span class="s2">&quot;/var/log/cback3.log&quot;</span>
<span class="n">DEFAULT_OWNERSHIP</span>  <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="s2">&quot;adm&quot;</span><span class="p">,</span> <span class="p">]</span>
<span class="n">DEFAULT_MODE</span>       <span class="o">=</span> <span class="mo">0o640</span>

<span class="n">REBUILD_INDEX</span>      <span class="o">=</span> <span class="mi">0</span>        <span class="c1"># can&#39;t run with anything else, anyway</span>
<span class="n">VALIDATE_INDEX</span>     <span class="o">=</span> <span class="mi">0</span>        <span class="c1"># can&#39;t run with anything else, anyway</span>
<span class="n">INITIALIZE_INDEX</span>   <span class="o">=</span> <span class="mi">0</span>        <span class="c1"># can&#39;t run with anything else, anyway</span>
<span class="n">COLLECT_INDEX</span>      <span class="o">=</span> <span class="mi">100</span>
<span class="n">STAGE_INDEX</span>        <span class="o">=</span> <span class="mi">200</span>
<span class="n">STORE_INDEX</span>        <span class="o">=</span> <span class="mi">300</span>
<span class="n">PURGE_INDEX</span>        <span class="o">=</span> <span class="mi">400</span>

<span class="n">VALID_ACTIONS</span>      <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;collect&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">,</span> <span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="s2">&quot;purge&quot;</span><span class="p">,</span> <span class="s2">&quot;rebuild&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;initialize&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="p">]</span>
<span class="n">COMBINE_ACTIONS</span>    <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;collect&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">,</span> <span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="s2">&quot;purge&quot;</span><span class="p">,</span> <span class="p">]</span>
<span class="n">NONCOMBINE_ACTIONS</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;rebuild&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;initialize&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="p">]</span>

<span class="n">SHORT_SWITCHES</span>     <span class="o">=</span> <span class="s2">&quot;hVbqc:fMNl:o:m:OdsD&quot;</span>
<span class="n">LONG_SWITCHES</span>      <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;help&#39;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="s1">&#39;quiet&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;config=&#39;</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="s1">&#39;managed&#39;</span><span class="p">,</span> <span class="s1">&#39;managed-only&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;logfile=&#39;</span><span class="p">,</span> <span class="s1">&#39;owner=&#39;</span><span class="p">,</span> <span class="s1">&#39;mode=&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">,</span> <span class="s1">&#39;diagnostics&#39;</span><span class="p">,</span> <span class="p">]</span>


<span class="c1">#######################################################################</span>
<span class="c1"># Public functions</span>
<span class="c1">#######################################################################</span>

<span class="c1">#################</span>
<span class="c1"># cli() function</span>
<span class="c1">#################</span>

<div class="viewcode-block" id="cli"><a class="viewcode-back" href="../../CedarBackup3.html#CedarBackup3.cli.cli">[docs]</a><span class="k">def</span> <span class="nf">cli</span><span class="p">():</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Implements the command-line interface for the ``cback3`` script.</span>

<span class="sd">   Essentially, this is the &quot;main routine&quot; for the cback3 script.  It does all</span>
<span class="sd">   of the argument processing for the script, and then sets about executing the</span>
<span class="sd">   indicated actions.</span>

<span class="sd">   As a general rule, only the actions indicated on the command line will be</span>
<span class="sd">   executed.   We will accept any of the built-in actions and any of the</span>
<span class="sd">   configured extended actions (which makes action list verification a two-</span>
<span class="sd">   step process).</span>

<span class="sd">   The ``&#39;all&#39;`` action has a special meaning: it means that the built-in set of</span>
<span class="sd">   actions (collect, stage, store, purge) will all be executed, in that order.</span>
<span class="sd">   Extended actions will be ignored as part of the ``&#39;all&#39;`` action.</span>

<span class="sd">   Raised exceptions always result in an immediate return.  Otherwise, we</span>
<span class="sd">   generally return when all specified actions have been completed.  Actions</span>
<span class="sd">   are ignored if the help, version or validate flags are set.</span>

<span class="sd">   A different error code is returned for each type of failure:</span>

<span class="sd">      - ``1``: The Python interpreter version is &lt; 3.4</span>
<span class="sd">      - ``2``: Error processing command-line arguments</span>
<span class="sd">      - ``3``: Error configuring logging</span>
<span class="sd">      - ``4``: Error parsing indicated configuration file</span>
<span class="sd">      - ``5``: Backup was interrupted with a CTRL-C or similar</span>
<span class="sd">      - ``6``: Error executing specified backup actions</span>

<span class="sd">   *Note:* This function contains a good amount of logging at the INFO level,</span>
<span class="sd">   because this is the right place to document high-level flow of control (i.e.</span>
<span class="sd">   what the command-line options were, what config file was being used, etc.)</span>

<span class="sd">   *Note:* We assume that anything that *must* be seen on the screen is logged</span>
<span class="sd">   at the ERROR level.  Errors that occur before logging can be configured are</span>
<span class="sd">   written to ``sys.stderr``.</span>

<span class="sd">   Returns:</span>
<span class="sd">       Error code as described above</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span> <span class="o">&lt;</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
         <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Python 3 version 3.4 or greater required.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
         <span class="k">return</span> <span class="mi">1</span>
   <span class="k">except</span><span class="p">:</span>
      <span class="c1"># sys.version_info isn&#39;t available before 2.0</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Python 3 version 3.4 or greater required.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="mi">1</span>

   <span class="k">try</span><span class="p">:</span>
      <span class="n">options</span> <span class="o">=</span> <span class="n">Options</span><span class="p">(</span><span class="n">argumentList</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Specified command-line actions: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>
   <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">_usage</span><span class="p">()</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; *** Error: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
      <span class="k">return</span> <span class="mi">2</span>

   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
      <span class="n">_usage</span><span class="p">()</span>
      <span class="k">return</span> <span class="mi">0</span>
   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
      <span class="n">_version</span><span class="p">()</span>
      <span class="k">return</span> <span class="mi">0</span>
   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
      <span class="n">_diagnostics</span><span class="p">()</span>
      <span class="k">return</span> <span class="mi">0</span>

   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">stacktrace</span><span class="p">:</span>
      <span class="n">logfile</span> <span class="o">=</span> <span class="n">setupLogging</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="n">logfile</span> <span class="o">=</span> <span class="n">setupLogging</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Error setting up logging: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
         <span class="k">return</span> <span class="mi">3</span>

   <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cedar Backup run started.&quot;</span><span class="p">)</span>
   <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Options were [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
   <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Logfile is [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">logfile</span><span class="p">)</span>
   <span class="n">Diagnostics</span><span class="p">()</span><span class="o">.</span><span class="n">logDiagnostics</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>

   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using default configuration file.&quot;</span><span class="p">)</span>
      <span class="n">configPath</span> <span class="o">=</span> <span class="n">DEFAULT_CONFIG</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using user-supplied configuration file.&quot;</span><span class="p">)</span>
      <span class="n">configPath</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">config</span>

   <span class="n">executeLocal</span> <span class="o">=</span> <span class="kc">True</span>
   <span class="n">executeManaged</span> <span class="o">=</span> <span class="kc">False</span>
   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">managedOnly</span><span class="p">:</span>
      <span class="n">executeLocal</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">executeManaged</span> <span class="o">=</span> <span class="kc">True</span>
   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">managed</span><span class="p">:</span>
      <span class="n">executeManaged</span> <span class="o">=</span> <span class="kc">True</span>
   <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Execute local actions: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">executeLocal</span><span class="p">)</span>
   <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Execute managed actions: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">executeManaged</span><span class="p">)</span>

   <span class="k">try</span><span class="p">:</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Configuration path is [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">configPath</span><span class="p">)</span>
      <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">xmlPath</span><span class="o">=</span><span class="n">configPath</span><span class="p">)</span>
      <span class="n">customizeOverrides</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
      <span class="n">setupPathResolver</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
      <span class="n">actionSet</span> <span class="o">=</span> <span class="n">_ActionSet</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">actions</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">extensions</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                             <span class="n">config</span><span class="o">.</span><span class="n">peers</span><span class="p">,</span> <span class="n">executeManaged</span><span class="p">,</span> <span class="n">executeLocal</span><span class="p">)</span>
   <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error reading or handling configuration: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cedar Backup run completed with status 4.&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="mi">4</span>

   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">stacktrace</span><span class="p">:</span>
      <span class="n">actionSet</span><span class="o">.</span><span class="n">executeActions</span><span class="p">(</span><span class="n">configPath</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="n">actionSet</span><span class="o">.</span><span class="n">executeActions</span><span class="p">(</span><span class="n">configPath</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Backup interrupted.&quot;</span><span class="p">)</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cedar Backup run completed with status 5.&quot;</span><span class="p">)</span>
         <span class="k">return</span> <span class="mi">5</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error executing backup: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cedar Backup run completed with status 6.&quot;</span><span class="p">)</span>
         <span class="k">return</span> <span class="mi">6</span>

   <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cedar Backup run completed with status 0.&quot;</span><span class="p">)</span>
   <span class="k">return</span> <span class="mi">0</span></div>


<span class="c1">########################################################################</span>
<span class="c1"># Action-related class definition</span>
<span class="c1">########################################################################</span>

<span class="c1">####################</span>
<span class="c1"># _ActionItem class</span>
<span class="c1">####################</span>

<span class="nd">@total_ordering</span>
<span class="k">class</span> <span class="nc">_ActionItem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Class representing a single action to be executed.</span>

<span class="sd">   This class represents a single named action to be executed, and understands</span>
<span class="sd">   how to execute that action.</span>

<span class="sd">   The built-in actions will use only the options and config values.  We also</span>
<span class="sd">   pass in the config path so that extension modules can re-parse configuration</span>
<span class="sd">   if they want to, to add in extra information.</span>

<span class="sd">   This class is also where pre-action and post-action hooks are executed.  An</span>
<span class="sd">   action item is instantiated in terms of optional pre- and post-action hook</span>
<span class="sd">   objects (config.ActionHook), which are then executed at the appropriate time</span>
<span class="sd">   (if set).</span>

<span class="sd">   *Note:* The comparison operators for this class have been implemented to only</span>
<span class="sd">   compare based on the index and SORT_ORDER value, and ignore all other</span>
<span class="sd">   values.  This is so that the action set list can be easily sorted first by</span>
<span class="sd">   type (_ActionItem before _ManagedActionItem) and then by index within type.</span>

<span class="sd">   Attributes:</span>
<span class="sd">      SORT_ORDER: Defines a sort order to order properly between types</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">SORT_ORDER</span> <span class="o">=</span> <span class="mi">0</span>

   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">preHooks</span><span class="p">,</span> <span class="n">postHooks</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Default constructor.</span>

<span class="sd">      It&#39;s OK to pass ``None`` for ``index``, ``preHooks`` or ``postHooks``, but not</span>
<span class="sd">      for ``name``.</span>

<span class="sd">      Args:</span>
<span class="sd">         index: Index of the item (or ``None``)</span>
<span class="sd">         name: Name of the action that is being executed</span>
<span class="sd">         preHooks: List of pre-action hooks in terms of an ``ActionHook`` object, or ``None``</span>
<span class="sd">         postHooks: List of post-action hooks in terms of an ``ActionHook`` object, or ``None``</span>
<span class="sd">         function: Reference to function associated with item</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">preHooks</span> <span class="o">=</span> <span class="n">preHooks</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">postHooks</span> <span class="o">=</span> <span class="n">postHooks</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span>

   <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Equals operator, implemented in terms of original Python 2 compare operator.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

   <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Less-than operator, implemented in terms of original Python 2 compare operator.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>

   <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Greater-than operator, implemented in terms of original Python 2 compare operator.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

   <span class="k">def</span> <span class="nf">__cmp__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Original Python 2 comparison operator.</span>
<span class="sd">      The only thing we compare is the item&#39;s index.</span>
<span class="sd">      Args:</span>
<span class="sd">         other: Other object to compare to</span>
<span class="sd">      Returns:</span>
<span class="sd">          -1/0/1 depending on whether self is ``&lt;``, ``=`` or ``&gt;`` other</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SORT_ORDER</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">SORT_ORDER</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SORT_ORDER</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">SORT_ORDER</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">):</span>
               <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">return</span> <span class="mi">1</span>
      <span class="k">return</span> <span class="mi">0</span>

   <span class="k">def</span> <span class="nf">executeAction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configPath</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Executes the action associated with an item, including hooks.</span>

<span class="sd">      See class notes for more details on how the action is executed.</span>

<span class="sd">      Args:</span>
<span class="sd">         configPath: Path to configuration file on disk</span>
<span class="sd">         options: Command-line options to be passed to action</span>
<span class="sd">         config: Parsed configuration to be passed to action</span>

<span class="sd">      Raises:</span>
<span class="sd">         Exception: If there is a problem executing the action</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Executing [</span><span class="si">%s</span><span class="s2">] action.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preHooks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preHooks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_executeHook</span><span class="p">(</span><span class="s2">&quot;pre-action&quot;</span><span class="p">,</span> <span class="n">hook</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_executeAction</span><span class="p">(</span><span class="n">configPath</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postHooks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">postHooks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_executeHook</span><span class="p">(</span><span class="s2">&quot;post-action&quot;</span><span class="p">,</span> <span class="n">hook</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">_executeAction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configPath</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Executes the action, specifically the function associated with the action.</span>
<span class="sd">      Args:</span>
<span class="sd">         configPath: Path to configuration file on disk</span>
<span class="sd">         options: Command-line options to be passed to action</span>
<span class="sd">         config: Parsed configuration to be passed to action</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calling action function [</span><span class="si">%s</span><span class="s2">], execution index [</span><span class="si">%d</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">configPath</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">_executeHook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>  <span class="c1"># pylint: disable=W0622,R0201</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Executes a hook command via :any:`util.executeCommand`.</span>
<span class="sd">      Args:</span>
<span class="sd">         type: String describing the type of hook, for logging</span>
<span class="sd">         hook: Hook, in terms of a ``ActionHook`` object</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">fields</span> <span class="o">=</span> <span class="n">splitCommandLine</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Executing </span><span class="si">%s</span><span class="s2"> hook for action [</span><span class="si">%s</span><span class="s2">]: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">hook</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">executeCommand</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:])[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Error (</span><span class="si">%d</span><span class="s2">) executing </span><span class="si">%s</span><span class="s2"> hook for action [</span><span class="si">%s</span><span class="s2">]: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">hook</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))</span>


<span class="c1">###########################</span>
<span class="c1"># _ManagedActionItem class</span>
<span class="c1">###########################</span>

<span class="nd">@total_ordering</span>
<span class="k">class</span> <span class="nc">_ManagedActionItem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Class representing a single action to be executed on a managed peer.</span>

<span class="sd">   This class represents a single named action to be executed, and understands</span>
<span class="sd">   how to execute that action.</span>

<span class="sd">   Actions to be executed on a managed peer rely on peer configuration and</span>
<span class="sd">   on the full-backup flag.  All other configuration takes place on the remote</span>
<span class="sd">   peer itself.</span>

<span class="sd">   *Note:* The comparison operators for this class have been implemented to only</span>
<span class="sd">   compare based on the index and SORT_ORDER value, and ignore all other</span>
<span class="sd">   values.  This is so that the action set list can be easily sorted first by</span>
<span class="sd">   type (_ActionItem before _ManagedActionItem) and then by index within type.</span>

<span class="sd">   Attributes:</span>
<span class="sd">      SORT_ORDER: Defines a sort order to order properly between types</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="n">SORT_ORDER</span> <span class="o">=</span> <span class="mi">1</span>

   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">remotePeers</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Default constructor.</span>

<span class="sd">      Args:</span>
<span class="sd">         index: Index of the item (or ``None``)</span>
<span class="sd">         name: Name of the action that is being executed</span>
<span class="sd">         remotePeers: List of remote peers on which to execute the action</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">remotePeers</span> <span class="o">=</span> <span class="n">remotePeers</span>

   <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Equals operator, implemented in terms of original Python 2 compare operator.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

   <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Less-than operator, implemented in terms of original Python 2 compare operator.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>

   <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Greater-than operator, implemented in terms of original Python 2 compare operator.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

   <span class="k">def</span> <span class="nf">__cmp__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Original Python 2 comparison operator.</span>
<span class="sd">      The only thing we compare is the item&#39;s index.</span>
<span class="sd">      Args:</span>
<span class="sd">         other: Other object to compare to</span>
<span class="sd">      Returns:</span>
<span class="sd">          -1/0/1 depending on whether self is ``&lt;``, ``=`` or ``&gt;`` other</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SORT_ORDER</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">SORT_ORDER</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SORT_ORDER</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">SORT_ORDER</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">):</span>
               <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">return</span> <span class="mi">1</span>
      <span class="k">return</span> <span class="mi">0</span>

   <span class="c1"># pylint: disable=W0613</span>
   <span class="k">def</span> <span class="nf">executeAction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configPath</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Executes the managed action associated with an item.</span>

<span class="sd">      *Note:* Only options.full is actually used.  The rest of the arguments</span>
<span class="sd">      exist to satisfy the ActionItem iterface.</span>

<span class="sd">      *Note:* Errors here result in a message logged to ERROR, but no thrown</span>
<span class="sd">      exception.  The analogy is the stage action where a problem with one host</span>
<span class="sd">      should not kill the entire backup.  Since we&#39;re logging an error, the</span>
<span class="sd">      administrator will get an email.</span>

<span class="sd">      Args:</span>
<span class="sd">         configPath: Path to configuration file on disk</span>
<span class="sd">         options: Command-line options to be passed to action</span>
<span class="sd">         config: Parsed configuration to be passed to action</span>

<span class="sd">      Raises:</span>
<span class="sd">         Exception: If there is a problem executing the action</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">for</span> <span class="n">peer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">remotePeers</span><span class="p">:</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Executing managed action [</span><span class="si">%s</span><span class="s2">] on peer [</span><span class="si">%s</span><span class="s2">].&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">peer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="n">peer</span><span class="o">.</span><span class="n">executeManagedAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">full</span><span class="p">)</span>
         <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>   <span class="c1"># log the message and go on, so we don&#39;t kill the backup</span>

<span class="c1">###################</span>
<span class="c1"># _ActionSet class</span>
<span class="c1">###################</span>

<span class="k">class</span> <span class="nc">_ActionSet</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Class representing a set of local actions to be executed.</span>

<span class="sd">   This class does four different things.  First, it ensures that the actions</span>
<span class="sd">   specified on the command-line are sensible.  The command-line can only list</span>
<span class="sd">   either built-in actions or extended actions specified in configuration.</span>
<span class="sd">   Also, certain actions (in :any:`NONCOMBINE_ACTIONS`) cannot be combined with</span>
<span class="sd">   other actions.</span>

<span class="sd">   Second, the class enforces an execution order on the specified actions.  Any</span>
<span class="sd">   time actions are combined on the command line (either built-in actions or</span>
<span class="sd">   extended actions), we must make sure they get executed in a sensible order.</span>

<span class="sd">   Third, the class ensures that any pre-action or post-action hooks are</span>
<span class="sd">   scheduled and executed appropriately.  Hooks are configured by building a</span>
<span class="sd">   dictionary mapping between hook action name and command.  Pre-action hooks</span>
<span class="sd">   are executed immediately before their associated action, and post-action</span>
<span class="sd">   hooks are executed immediately after their associated action.</span>

<span class="sd">   Finally, the class properly interleaves local and managed actions so that</span>
<span class="sd">   the same action gets executed first locally and then on managed peers.</span>

<span class="sd">   &quot;&quot;&quot;</span>

   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">extensions</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">peers</span><span class="p">,</span> <span class="n">managed</span><span class="p">,</span> <span class="n">local</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Constructor for the ``_ActionSet`` class.</span>

<span class="sd">      This is kind of ugly, because the constructor has to set up a lot of data</span>
<span class="sd">      before being able to do anything useful.  The following data structures</span>
<span class="sd">      are initialized based on the input:</span>

<span class="sd">         - ``extensionNames``: List of extensions available in configuration</span>
<span class="sd">         - ``preHookMap``: Mapping from action name to list of ``PreActionHook``</span>
<span class="sd">         - ``postHookMap``: Mapping from action name to list of ``PostActionHook``</span>
<span class="sd">         - ``functionMap``: Mapping from action name to Python function</span>
<span class="sd">         - ``indexMap``: Mapping from action name to execution index</span>
<span class="sd">         - ``peerMap``: Mapping from action name to set of ``RemotePeer``</span>
<span class="sd">         - ``actionMap``: Mapping from action name to ``_ActionItem``</span>

<span class="sd">      Once these data structures are set up, the command line is validated to</span>
<span class="sd">      make sure only valid actions have been requested, and in a sensible</span>
<span class="sd">      combination.  Then, all of the data is used to build ``self.actionSet``,</span>
<span class="sd">      the set action items to be executed by ``executeActions()``.  This list</span>
<span class="sd">      might contain either ``_ActionItem`` or ``_ManagedActionItem``.</span>

<span class="sd">      Args:</span>
<span class="sd">         actions: Names of actions specified on the command-line</span>
<span class="sd">         extensions: Extended action configuration (i.e. config.extensions)</span>
<span class="sd">         options: Options configuration (i.e. config.options)</span>
<span class="sd">         peers: Peers configuration (i.e. config.peers)</span>
<span class="sd">         managed: Whether to include managed actions in the set</span>
<span class="sd">         local: Whether to include local actions in the set</span>

<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If one of the specified actions is invalid</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">extensionNames</span> <span class="o">=</span> <span class="n">_ActionSet</span><span class="o">.</span><span class="n">_deriveExtensionNames</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>
      <span class="p">(</span><span class="n">preHookMap</span><span class="p">,</span> <span class="n">postHookMap</span><span class="p">)</span> <span class="o">=</span> <span class="n">_ActionSet</span><span class="o">.</span><span class="n">_buildHookMaps</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">hooks</span><span class="p">)</span>
      <span class="n">functionMap</span> <span class="o">=</span> <span class="n">_ActionSet</span><span class="o">.</span><span class="n">_buildFunctionMap</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>
      <span class="n">indexMap</span> <span class="o">=</span> <span class="n">_ActionSet</span><span class="o">.</span><span class="n">_buildIndexMap</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>
      <span class="n">peerMap</span> <span class="o">=</span> <span class="n">_ActionSet</span><span class="o">.</span><span class="n">_buildPeerMap</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">peers</span><span class="p">)</span>
      <span class="n">actionMap</span> <span class="o">=</span> <span class="n">_ActionSet</span><span class="o">.</span><span class="n">_buildActionMap</span><span class="p">(</span><span class="n">managed</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">extensionNames</span><span class="p">,</span> <span class="n">functionMap</span><span class="p">,</span>
                                             <span class="n">indexMap</span><span class="p">,</span> <span class="n">preHookMap</span><span class="p">,</span> <span class="n">postHookMap</span><span class="p">,</span> <span class="n">peerMap</span><span class="p">)</span>
      <span class="n">_ActionSet</span><span class="o">.</span><span class="n">_validateActions</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">extensionNames</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">actionSet</span> <span class="o">=</span> <span class="n">_ActionSet</span><span class="o">.</span><span class="n">_buildActionSet</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">actionMap</span><span class="p">)</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_deriveExtensionNames</span><span class="p">(</span><span class="n">extensions</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Builds a list of extended actions that are available in configuration.</span>
<span class="sd">      Args:</span>
<span class="sd">         extensions: Extended action configuration (i.e. config.extensions)</span>
<span class="sd">      Returns:</span>
<span class="sd">          List of extended action names</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">extensionNames</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">if</span> <span class="n">extensions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extensions</span><span class="o">.</span><span class="n">actions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">extensions</span><span class="o">.</span><span class="n">actions</span><span class="p">:</span>
            <span class="n">extensionNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">extensionNames</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_buildHookMaps</span><span class="p">(</span><span class="n">hooks</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Build two mappings from action name to configured ``ActionHook``.</span>
<span class="sd">      Args:</span>
<span class="sd">         hooks: List of pre- and post-action hooks (i.e. config.options.hooks)</span>
<span class="sd">      Returns:</span>
<span class="sd">          Tuple of (pre hook dictionary, post hook dictionary)</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">preHookMap</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">postHookMap</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">if</span> <span class="n">hooks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hook</span><span class="o">.</span><span class="n">before</span><span class="p">:</span>
               <span class="k">if</span> <span class="ow">not</span> <span class="n">hook</span><span class="o">.</span><span class="n">action</span> <span class="ow">in</span> <span class="n">preHookMap</span><span class="p">:</span>
                  <span class="n">preHookMap</span><span class="p">[</span><span class="n">hook</span><span class="o">.</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
               <span class="n">preHookMap</span><span class="p">[</span><span class="n">hook</span><span class="o">.</span><span class="n">action</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">hook</span><span class="o">.</span><span class="n">after</span><span class="p">:</span>
               <span class="k">if</span> <span class="ow">not</span> <span class="n">hook</span><span class="o">.</span><span class="n">action</span> <span class="ow">in</span> <span class="n">postHookMap</span><span class="p">:</span>
                  <span class="n">postHookMap</span><span class="p">[</span><span class="n">hook</span><span class="o">.</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
               <span class="n">postHookMap</span><span class="p">[</span><span class="n">hook</span><span class="o">.</span><span class="n">action</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">preHookMap</span><span class="p">,</span> <span class="n">postHookMap</span><span class="p">)</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_buildFunctionMap</span><span class="p">(</span><span class="n">extensions</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Builds a mapping from named action to action function.</span>
<span class="sd">      Args:</span>
<span class="sd">         extensions: Extended action configuration (i.e. config.extensions)</span>
<span class="sd">      Returns:</span>
<span class="sd">          Dictionary mapping action to function</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">functionMap</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">functionMap</span><span class="p">[</span><span class="s1">&#39;rebuild&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">executeRebuild</span>
      <span class="n">functionMap</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">executeValidate</span>
      <span class="n">functionMap</span><span class="p">[</span><span class="s1">&#39;initialize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">executeInitialize</span>
      <span class="n">functionMap</span><span class="p">[</span><span class="s1">&#39;collect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">executeCollect</span>
      <span class="n">functionMap</span><span class="p">[</span><span class="s1">&#39;stage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">executeStage</span>
      <span class="n">functionMap</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">executeStore</span>
      <span class="n">functionMap</span><span class="p">[</span><span class="s1">&#39;purge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">executePurge</span>
      <span class="k">if</span> <span class="n">extensions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extensions</span><span class="o">.</span><span class="n">actions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">extensions</span><span class="o">.</span><span class="n">actions</span><span class="p">:</span>
            <span class="n">functionMap</span><span class="p">[</span><span class="n">action</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">getFunctionReference</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">function</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">functionMap</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_buildIndexMap</span><span class="p">(</span><span class="n">extensions</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Builds a mapping from action name to proper execution index.</span>

<span class="sd">      If extensions configuration is ``None``, or there are no configured</span>
<span class="sd">      extended actions, the ordering dictionary will only include the built-in</span>
<span class="sd">      actions and their standard indices.</span>

<span class="sd">      Otherwise, if the extensions order mode is ``None`` or ``&quot;index&quot;``, actions</span>
<span class="sd">      will scheduled by explicit index; and if the extensions order mode is</span>
<span class="sd">      ``&quot;dependency&quot;``, actions will be scheduled using a dependency graph.</span>

<span class="sd">      Args:</span>
<span class="sd">         extensions: Extended action configuration (i.e. config.extensions)</span>

<span class="sd">      Returns:</span>
<span class="sd">          Dictionary mapping action name to integer execution index</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">indexMap</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">if</span> <span class="n">extensions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">extensions</span><span class="o">.</span><span class="n">actions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">extensions</span><span class="o">.</span><span class="n">actions</span> <span class="o">==</span> <span class="p">[]:</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Action ordering will use &#39;index&#39; order mode.&quot;</span><span class="p">)</span>
         <span class="n">indexMap</span><span class="p">[</span><span class="s1">&#39;rebuild&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">REBUILD_INDEX</span>
         <span class="n">indexMap</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">VALIDATE_INDEX</span>
         <span class="n">indexMap</span><span class="p">[</span><span class="s1">&#39;initialize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">INITIALIZE_INDEX</span>
         <span class="n">indexMap</span><span class="p">[</span><span class="s1">&#39;collect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">COLLECT_INDEX</span>
         <span class="n">indexMap</span><span class="p">[</span><span class="s1">&#39;stage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">STAGE_INDEX</span>
         <span class="n">indexMap</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">STORE_INDEX</span>
         <span class="n">indexMap</span><span class="p">[</span><span class="s1">&#39;purge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PURGE_INDEX</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Completed filling in action indices for built-in actions.&quot;</span><span class="p">)</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Action order will be: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sortDict</span><span class="p">(</span><span class="n">indexMap</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">extensions</span><span class="o">.</span><span class="n">orderMode</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">extensions</span><span class="o">.</span><span class="n">orderMode</span> <span class="o">==</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Action ordering will use &#39;index&#39; order mode.&quot;</span><span class="p">)</span>
            <span class="n">indexMap</span><span class="p">[</span><span class="s1">&#39;rebuild&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">REBUILD_INDEX</span>
            <span class="n">indexMap</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">VALIDATE_INDEX</span>
            <span class="n">indexMap</span><span class="p">[</span><span class="s1">&#39;initialize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">INITIALIZE_INDEX</span>
            <span class="n">indexMap</span><span class="p">[</span><span class="s1">&#39;collect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">COLLECT_INDEX</span>
            <span class="n">indexMap</span><span class="p">[</span><span class="s1">&#39;stage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">STAGE_INDEX</span>
            <span class="n">indexMap</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">STORE_INDEX</span>
            <span class="n">indexMap</span><span class="p">[</span><span class="s1">&#39;purge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PURGE_INDEX</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Completed filling in action indices for built-in actions.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">extensions</span><span class="o">.</span><span class="n">actions</span><span class="p">:</span>
               <span class="n">indexMap</span><span class="p">[</span><span class="n">action</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">index</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Completed filling in action indices for extended actions.&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Action order will be: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sortDict</span><span class="p">(</span><span class="n">indexMap</span><span class="p">))</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Action ordering will use &#39;dependency&#39; order mode.&quot;</span><span class="p">)</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="n">DirectedGraph</span><span class="p">(</span><span class="s2">&quot;dependencies&quot;</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">createVertex</span><span class="p">(</span><span class="s2">&quot;rebuild&quot;</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">createVertex</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">createVertex</span><span class="p">(</span><span class="s2">&quot;initialize&quot;</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">createVertex</span><span class="p">(</span><span class="s2">&quot;collect&quot;</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">createVertex</span><span class="p">(</span><span class="s2">&quot;stage&quot;</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">createVertex</span><span class="p">(</span><span class="s2">&quot;store&quot;</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">createVertex</span><span class="p">(</span><span class="s2">&quot;purge&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">extensions</span><span class="o">.</span><span class="n">actions</span><span class="p">:</span>
               <span class="n">graph</span><span class="o">.</span><span class="n">createVertex</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">createEdge</span><span class="p">(</span><span class="s2">&quot;collect&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">)</span>   <span class="c1"># Collect must run before stage, store or purge</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">createEdge</span><span class="p">(</span><span class="s2">&quot;collect&quot;</span><span class="p">,</span> <span class="s2">&quot;store&quot;</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">createEdge</span><span class="p">(</span><span class="s2">&quot;collect&quot;</span><span class="p">,</span> <span class="s2">&quot;purge&quot;</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">createEdge</span><span class="p">(</span><span class="s2">&quot;stage&quot;</span><span class="p">,</span> <span class="s2">&quot;store&quot;</span><span class="p">)</span>     <span class="c1"># Stage must run before store or purge</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">createEdge</span><span class="p">(</span><span class="s2">&quot;stage&quot;</span><span class="p">,</span> <span class="s2">&quot;purge&quot;</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">createEdge</span><span class="p">(</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="s2">&quot;purge&quot;</span><span class="p">)</span>     <span class="c1"># Store must run before purge</span>
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">extensions</span><span class="o">.</span><span class="n">actions</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">beforeList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                  <span class="k">for</span> <span class="n">vertex</span> <span class="ow">in</span> <span class="n">action</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">beforeList</span><span class="p">:</span>
                     <span class="k">try</span><span class="p">:</span>
                        <span class="n">graph</span><span class="o">.</span><span class="n">createEdge</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">vertex</span><span class="p">)</span>   <span class="c1"># actions that this action must be run before</span>
                     <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Dependency [</span><span class="si">%s</span><span class="s2">] on extension [</span><span class="si">%s</span><span class="s2">] is unknown.&quot;</span><span class="p">,</span> <span class="n">vertex</span><span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to determine proper action order due to invalid dependency.&quot;</span><span class="p">)</span>
               <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">afterList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                  <span class="k">for</span> <span class="n">vertex</span> <span class="ow">in</span> <span class="n">action</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">afterList</span><span class="p">:</span>
                     <span class="k">try</span><span class="p">:</span>
                        <span class="n">graph</span><span class="o">.</span><span class="n">createEdge</span><span class="p">(</span><span class="n">vertex</span><span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>   <span class="c1"># actions that this action must be run after</span>
                     <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Dependency [</span><span class="si">%s</span><span class="s2">] on extension [</span><span class="si">%s</span><span class="s2">] is unknown.&quot;</span><span class="p">,</span> <span class="n">vertex</span><span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to determine proper action order due to invalid dependency.&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
               <span class="n">ordering</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">topologicalSort</span><span class="p">()</span>
               <span class="n">indexMap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">ordering</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ordering</span><span class="p">))])</span>
               <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Action order will be: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ordering</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
               <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to determine proper action order due to dependency recursion.&quot;</span><span class="p">)</span>
               <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Extensions configuration is invalid (check for loops).&quot;</span><span class="p">)</span>
               <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to determine proper action order due to dependency recursion.&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">indexMap</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_buildActionMap</span><span class="p">(</span><span class="n">managed</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">extensionNames</span><span class="p">,</span> <span class="n">functionMap</span><span class="p">,</span> <span class="n">indexMap</span><span class="p">,</span> <span class="n">preHookMap</span><span class="p">,</span> <span class="n">postHookMap</span><span class="p">,</span> <span class="n">peerMap</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Builds a mapping from action name to list of action items.</span>

<span class="sd">      We build either ``_ActionItem`` or ``_ManagedActionItem`` objects here.</span>

<span class="sd">      In most cases, the mapping from action name to ``_ActionItem`` is 1:1.</span>
<span class="sd">      The exception is the &quot;all&quot; action, which is a special case.  However, a</span>
<span class="sd">      list is returned in all cases, just for consistency later.  Each</span>
<span class="sd">      ``_ActionItem`` will be created with a proper function reference and index</span>
<span class="sd">      value for execution ordering.</span>

<span class="sd">      The mapping from action name to ``_ManagedActionItem`` is always 1:1.</span>
<span class="sd">      Each managed action item contains a list of peers which the action should</span>
<span class="sd">      be executed.</span>

<span class="sd">      Args:</span>
<span class="sd">         managed: Whether to include managed actions in the set</span>
<span class="sd">         local: Whether to include local actions in the set</span>
<span class="sd">         extensionNames: List of valid extended action names</span>
<span class="sd">         functionMap: Dictionary mapping action name to Python function</span>
<span class="sd">         indexMap: Dictionary mapping action name to integer execution index</span>
<span class="sd">         preHookMap: Dictionary mapping action name to pre hooks (if any) for the action</span>
<span class="sd">         postHookMap: Dictionary mapping action name to post hooks (if any) for the action</span>
<span class="sd">         peerMap: Dictionary mapping action name to list of remote peers on which to execute the action</span>

<span class="sd">      Returns:</span>
<span class="sd">          Dictionary mapping action name to list of ``_ActionItem`` objects</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">actionMap</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">extensionNames</span> <span class="o">+</span> <span class="n">VALID_ACTIONS</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span> <span class="c1"># do this one later</span>
            <span class="n">function</span> <span class="o">=</span> <span class="n">functionMap</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">indexMap</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">actionMap</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
               <span class="p">(</span><span class="n">preHooks</span><span class="p">,</span> <span class="n">postHooks</span><span class="p">)</span> <span class="o">=</span> <span class="n">_ActionSet</span><span class="o">.</span><span class="n">_deriveHooks</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">preHookMap</span><span class="p">,</span> <span class="n">postHookMap</span><span class="p">)</span>
               <span class="n">actionMap</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_ActionItem</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">preHooks</span><span class="p">,</span> <span class="n">postHooks</span><span class="p">,</span> <span class="n">function</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">managed</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">peerMap</span><span class="p">:</span>
                  <span class="n">actionMap</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_ManagedActionItem</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">peerMap</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
      <span class="n">actionMap</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">actionMap</span><span class="p">[</span><span class="s1">&#39;collect&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">actionMap</span><span class="p">[</span><span class="s1">&#39;stage&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">actionMap</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">actionMap</span><span class="p">[</span><span class="s1">&#39;purge&#39;</span><span class="p">]</span>
      <span class="k">return</span> <span class="n">actionMap</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_buildPeerMap</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">peers</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Build a mapping from action name to list of remote peers.</span>

<span class="sd">      There will be one entry in the mapping for each managed action.  If there</span>
<span class="sd">      are no managed peers, the mapping will be empty.  Only managed actions</span>
<span class="sd">      will be listed in the mapping.</span>

<span class="sd">      Args:</span>
<span class="sd">         options: Option configuration (i.e. config.options)</span>
<span class="sd">         peers: Peers configuration (i.e. config.peers)</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">peerMap</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">if</span> <span class="n">peers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">peers</span><span class="o">.</span><span class="n">remotePeers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">peer</span> <span class="ow">in</span> <span class="n">peers</span><span class="o">.</span><span class="n">remotePeers</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">peer</span><span class="o">.</span><span class="n">managed</span><span class="p">:</span>
                  <span class="n">remoteUser</span> <span class="o">=</span> <span class="n">_ActionSet</span><span class="o">.</span><span class="n">_getRemoteUser</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">peer</span><span class="p">)</span>
                  <span class="n">rshCommand</span> <span class="o">=</span> <span class="n">_ActionSet</span><span class="o">.</span><span class="n">_getRshCommand</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">peer</span><span class="p">)</span>
                  <span class="n">cbackCommand</span> <span class="o">=</span> <span class="n">_ActionSet</span><span class="o">.</span><span class="n">_getCbackCommand</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">peer</span><span class="p">)</span>
                  <span class="n">managedActions</span> <span class="o">=</span> <span class="n">_ActionSet</span><span class="o">.</span><span class="n">_getManagedActions</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">peer</span><span class="p">)</span>
                  <span class="n">remotePeer</span> <span class="o">=</span> <span class="n">RemotePeer</span><span class="p">(</span><span class="n">peer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">workingDir</span><span class="p">,</span> <span class="n">remoteUser</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                          <span class="n">options</span><span class="o">.</span><span class="n">backupUser</span><span class="p">,</span> <span class="n">rshCommand</span><span class="p">,</span> <span class="n">cbackCommand</span><span class="p">)</span>
                  <span class="k">if</span> <span class="n">managedActions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                     <span class="k">for</span> <span class="n">managedAction</span> <span class="ow">in</span> <span class="n">managedActions</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">managedAction</span> <span class="ow">in</span> <span class="n">peerMap</span><span class="p">:</span>
                           <span class="k">if</span> <span class="n">remotePeer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">peerMap</span><span class="p">[</span><span class="n">managedAction</span><span class="p">]:</span>
                              <span class="n">peerMap</span><span class="p">[</span><span class="n">managedAction</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remotePeer</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                           <span class="n">peerMap</span><span class="p">[</span><span class="n">managedAction</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">remotePeer</span><span class="p">,</span> <span class="p">]</span>
      <span class="k">return</span> <span class="n">peerMap</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_deriveHooks</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">preHookDict</span><span class="p">,</span> <span class="n">postHookDict</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Derive pre- and post-action hooks, if any, associated with named action.</span>
<span class="sd">      Args:</span>
<span class="sd">         action: Name of action to look up</span>
<span class="sd">         preHookDict: Dictionary mapping pre-action hooks to action name</span>
<span class="sd">         postHookDict: Dictionary mapping post-action hooks to action name</span>
<span class="sd">      @return Tuple (preHooks, postHooks) per mapping, with None values if there is no hook</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">preHooks</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="n">postHooks</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">preHookDict</span><span class="p">:</span>
         <span class="n">preHooks</span> <span class="o">=</span> <span class="n">preHookDict</span><span class="p">[</span><span class="n">action</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">postHookDict</span><span class="p">:</span>
         <span class="n">postHooks</span> <span class="o">=</span> <span class="n">postHookDict</span><span class="p">[</span><span class="n">action</span><span class="p">]</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">preHooks</span><span class="p">,</span> <span class="n">postHooks</span><span class="p">)</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_validateActions</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">extensionNames</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Validate that the set of specified actions is sensible.</span>

<span class="sd">      Any specified action must either be a built-in action or must be among</span>
<span class="sd">      the extended actions defined in configuration.  The actions from within</span>
<span class="sd">      :any:`NONCOMBINE_ACTIONS` may not be combined with other actions.</span>

<span class="sd">      Args:</span>
<span class="sd">         actions: Names of actions specified on the command-line</span>
<span class="sd">         extensionNames: Names of extensions specified in configuration</span>

<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If one or more configured actions are not valid</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">actions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">actions</span> <span class="o">==</span> <span class="p">[]:</span>
         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No actions specified.&quot;</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VALID_ACTIONS</span> <span class="ow">and</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extensionNames</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Action [</span><span class="si">%s</span><span class="s2">] is not a valid action or extended action.&quot;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">NONCOMBINE_ACTIONS</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span> <span class="ow">and</span> <span class="n">actions</span> <span class="o">!=</span> <span class="p">[</span> <span class="n">action</span><span class="p">,</span> <span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Action [</span><span class="si">%s</span><span class="s2">] may not be combined with other actions.&quot;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_buildActionSet</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">actionMap</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Build set of actions to be executed.</span>

<span class="sd">      The set of actions is built in the proper order, so ``executeActions`` can</span>
<span class="sd">      spin through the set without thinking about it.  Since we&#39;ve already validated</span>
<span class="sd">      that the set of actions is sensible, we don&#39;t take any precautions here to</span>
<span class="sd">      make sure things are combined properly.  If the action is listed, it will</span>
<span class="sd">      be &quot;scheduled&quot; for execution.</span>

<span class="sd">      Args:</span>
<span class="sd">         actions: Names of actions specified on the command-line</span>
<span class="sd">         actionMap: Dictionary mapping action name to ``_ActionItem`` object</span>

<span class="sd">      Returns:</span>
<span class="sd">          Set of action items in proper order</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">actionSet</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
         <span class="n">actionSet</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">actionMap</span><span class="p">[</span><span class="n">action</span><span class="p">])</span>
      <span class="n">actionSet</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># sort the actions in order by index</span>
      <span class="k">return</span> <span class="n">actionSet</span>

   <span class="k">def</span> <span class="nf">executeActions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configPath</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Executes all actions and extended actions, in the proper order.</span>

<span class="sd">      Each action (whether built-in or extension) is executed in an identical</span>
<span class="sd">      manner.  The built-in actions will use only the options and config</span>
<span class="sd">      values.  We also pass in the config path so that extension modules can</span>
<span class="sd">      re-parse configuration if they want to, to add in extra information.</span>

<span class="sd">      Args:</span>
<span class="sd">         configPath: Path to configuration file on disk</span>
<span class="sd">         options: Command-line options to be passed to action functions</span>
<span class="sd">         config: Parsed configuration to be passed to action functions</span>

<span class="sd">      Raises:</span>
<span class="sd">         Exception: If there is a problem executing the actions</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Executing local actions.&quot;</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">actionItem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actionSet</span><span class="p">:</span>
         <span class="n">actionItem</span><span class="o">.</span><span class="n">executeAction</span><span class="p">(</span><span class="n">configPath</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_getRemoteUser</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">remotePeer</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Gets the remote user associated with a remote peer.</span>
<span class="sd">      Use peer&#39;s if possible, otherwise take from options section.</span>
<span class="sd">      Args:</span>
<span class="sd">         options: OptionsConfig object, as from config.options</span>
<span class="sd">         remotePeer: Configuration-style remote peer object</span>
<span class="sd">      Returns:</span>
<span class="sd">          Name of remote user associated with remote peer</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">remotePeer</span><span class="o">.</span><span class="n">remoteUser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">options</span><span class="o">.</span><span class="n">backupUser</span>
      <span class="k">return</span> <span class="n">remotePeer</span><span class="o">.</span><span class="n">remoteUser</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_getRshCommand</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">remotePeer</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Gets the RSH command associated with a remote peer.</span>
<span class="sd">      Use peer&#39;s if possible, otherwise take from options section.</span>
<span class="sd">      Args:</span>
<span class="sd">         options: OptionsConfig object, as from config.options</span>
<span class="sd">         remotePeer: Configuration-style remote peer object</span>
<span class="sd">      Returns:</span>
<span class="sd">          RSH command associated with remote peer</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">remotePeer</span><span class="o">.</span><span class="n">rshCommand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">options</span><span class="o">.</span><span class="n">rshCommand</span>
      <span class="k">return</span> <span class="n">remotePeer</span><span class="o">.</span><span class="n">rshCommand</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_getCbackCommand</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">remotePeer</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Gets the cback command associated with a remote peer.</span>
<span class="sd">      Use peer&#39;s if possible, otherwise take from options section.</span>
<span class="sd">      Args:</span>
<span class="sd">         options: OptionsConfig object, as from config.options</span>
<span class="sd">         remotePeer: Configuration-style remote peer object</span>
<span class="sd">      Returns:</span>
<span class="sd">          cback command associated with remote peer</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">remotePeer</span><span class="o">.</span><span class="n">cbackCommand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">options</span><span class="o">.</span><span class="n">cbackCommand</span>
      <span class="k">return</span> <span class="n">remotePeer</span><span class="o">.</span><span class="n">cbackCommand</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_getManagedActions</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">remotePeer</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Gets the managed actions list associated with a remote peer.</span>
<span class="sd">      Use peer&#39;s if possible, otherwise take from options section.</span>
<span class="sd">      Args:</span>
<span class="sd">         options: OptionsConfig object, as from config.options</span>
<span class="sd">         remotePeer: Configuration-style remote peer object</span>
<span class="sd">      Returns:</span>
<span class="sd">          Set of managed actions associated with remote peer</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">remotePeer</span><span class="o">.</span><span class="n">managedActions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">options</span><span class="o">.</span><span class="n">managedActions</span>
      <span class="k">return</span> <span class="n">remotePeer</span><span class="o">.</span><span class="n">managedActions</span>


<span class="c1">#######################################################################</span>
<span class="c1"># Utility functions</span>
<span class="c1">#######################################################################</span>

<span class="c1">####################</span>
<span class="c1"># _usage() function</span>
<span class="c1">####################</span>

<span class="k">def</span> <span class="nf">_usage</span><span class="p">(</span><span class="n">fd</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Prints usage information for the cback3 script.</span>
<span class="sd">   Args:</span>
<span class="sd">      fd: File descriptor used to print information</span>
<span class="sd">   *Note:* The ``fd`` is used rather than ``print`` to facilitate unit testing.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Usage: cback3 [switches] action(s)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; The following switches are accepted:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -h, --help         Display this usage/help listing</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -V, --version      Display version information</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -b, --verbose      Print verbose output as well as logging to disk</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -q, --quiet        Run quietly (display no output to the screen)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -c, --config       Path to config file (default: </span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">DEFAULT_CONFIG</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -f, --full         Perform a full backup, regardless of configuration</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -M, --managed      Include managed clients when executing actions</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -N, --managed-only Include ONLY managed clients when executing actions</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -l, --logfile      Path to logfile (default: </span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">DEFAULT_LOGFILE</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -o, --owner        Logfile ownership, user:group (default: </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DEFAULT_OWNERSHIP</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">DEFAULT_OWNERSHIP</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -m, --mode         Octal logfile permissions mode (default: </span><span class="si">%o</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">DEFAULT_MODE</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -O, --output       Record some sub-command (i.e. cdrecord) output to the log</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -d, --debug        Write debugging information to the log (implies --output)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -s, --stack        Dump a Python stack trace instead of swallowing exceptions</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># exactly 80 characters in width!</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -D, --diagnostics  Print runtime diagnostics to the screen and exit</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; The following actions may be specified:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   all                Take all normal actions (collect, stage, store, purge)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   collect            Take the collect action</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   stage              Take the stage action</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   store              Take the store action</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   purge              Take the purge action</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   rebuild            Rebuild </span><span class="se">\&quot;</span><span class="s2">this week&#39;s</span><span class="se">\&quot;</span><span class="s2"> disc if possible</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   validate           Validate configuration only</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   initialize         Initialize media for use with Cedar Backup</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; You may also specify extended actions that have been defined in</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; configuration.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; You must specify at least one action to take.  More than one of</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; the </span><span class="se">\&quot;</span><span class="s2">collect</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">stage</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">store</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">purge</span><span class="se">\&quot;</span><span class="s2"> actions and/or</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; extended actions may be specified in any arbitrary order; they</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; will be executed in a sensible order.  The </span><span class="se">\&quot;</span><span class="s2">all</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">rebuild</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\&quot;</span><span class="s2">validate</span><span class="se">\&quot;</span><span class="s2">, and </span><span class="se">\&quot;</span><span class="s2">initialize</span><span class="se">\&quot;</span><span class="s2"> actions may not be combined with</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; other actions.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1">######################</span>
<span class="c1"># _version() function</span>
<span class="c1">######################</span>

<span class="k">def</span> <span class="nf">_version</span><span class="p">(</span><span class="n">fd</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Prints version information for the cback3 script.</span>
<span class="sd">   Args:</span>
<span class="sd">      fd: File descriptor used to print information</span>
<span class="sd">   *Note:* The ``fd`` is used rather than ``print`` to facilitate unit testing.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Cedar Backup version </span><span class="si">%s</span><span class="s2">, released </span><span class="si">%s</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">VERSION</span><span class="p">,</span> <span class="n">DATE</span><span class="p">))</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Copyright (c) </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> &lt;</span><span class="si">%s</span><span class="s2">&gt;.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">COPYRIGHT</span><span class="p">,</span> <span class="n">AUTHOR</span><span class="p">,</span> <span class="n">EMAIL</span><span class="p">))</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; See CREDITS for a list of included code and other contributors.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; This is free software; there is NO warranty.  See the</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; GNU General Public License version 2 for copying conditions.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Use the --help option for usage information.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1">##########################</span>
<span class="c1"># _diagnostics() function</span>
<span class="c1">##########################</span>

<span class="k">def</span> <span class="nf">_diagnostics</span><span class="p">(</span><span class="n">fd</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Prints runtime diagnostics information.</span>
<span class="sd">   Args:</span>
<span class="sd">      fd: File descriptor used to print information</span>
<span class="sd">   *Note:* The ``fd`` is used rather than ``print`` to facilitate unit testing.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Diagnostics:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">Diagnostics</span><span class="p">()</span><span class="o">.</span><span class="n">printDiagnostics</span><span class="p">(</span><span class="n">fd</span><span class="o">=</span><span class="n">fd</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;   &quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1">##########################</span>
<span class="c1"># setupLogging() function</span>
<span class="c1">##########################</span>

<div class="viewcode-block" id="setupLogging"><a class="viewcode-back" href="../../CedarBackup3.html#CedarBackup3.cli.setupLogging">[docs]</a><span class="k">def</span> <span class="nf">setupLogging</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Set up logging based on command-line options.</span>

<span class="sd">   There are two kinds of logging: flow logging and output logging.  Output</span>
<span class="sd">   logging contains information about system commands executed by Cedar Backup,</span>
<span class="sd">   for instance the calls to ``mkisofs`` or ``mount``, etc.  Flow logging</span>
<span class="sd">   contains error and informational messages used to understand program flow.</span>
<span class="sd">   Flow log messages and output log messages are written to two different</span>
<span class="sd">   loggers target (``CedarBackup3.log`` and ``CedarBackup3.output``).  Flow log</span>
<span class="sd">   messages are written at the ERROR, INFO and DEBUG log levels, while output</span>
<span class="sd">   log messages are generally only written at the INFO log level.</span>

<span class="sd">   By default, output logging is disabled.  When the ``options.output`` or</span>
<span class="sd">   ``options.debug`` flags are set, output logging will be written to the</span>
<span class="sd">   configured logfile.  Output logging is never written to the screen.</span>

<span class="sd">   By default, flow logging is enabled at the ERROR level to the screen and at</span>
<span class="sd">   the INFO level to the configured logfile.  If the ``options.quiet`` flag is</span>
<span class="sd">   set, flow logging is enabled at the INFO level to the configured logfile</span>
<span class="sd">   only (i.e. no output will be sent to the screen).  If the ``options.verbose``</span>
<span class="sd">   flag is set, flow logging is enabled at the INFO level to both the screen</span>
<span class="sd">   and the configured logfile.  If the ``options.debug`` flag is set, flow</span>
<span class="sd">   logging is enabled at the DEBUG level to both the screen and the configured</span>
<span class="sd">   logfile.</span>

<span class="sd">   Args:</span>
<span class="sd">      options (:any:`Options` object): Command-line options</span>
<span class="sd">   Returns:</span>
<span class="sd">       Path to logfile on disk</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">logfile</span> <span class="o">=</span> <span class="n">_setupLogfile</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
   <span class="n">_setupFlowLogging</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
   <span class="n">_setupOutputLogging</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">logfile</span></div>

<span class="k">def</span> <span class="nf">_setupLogfile</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Sets up and creates logfile as needed.</span>

<span class="sd">   If the logfile already exists on disk, it will be left as-is, under the</span>
<span class="sd">   assumption that it was created with appropriate ownership and permissions.</span>
<span class="sd">   If the logfile does not exist on disk, it will be created as an empty file.</span>
<span class="sd">   Ownership and permissions will remain at their defaults unless user/group</span>
<span class="sd">   and/or mode are set in the options.  We ignore errors setting the indicated</span>
<span class="sd">   user and group.</span>

<span class="sd">   *Note:* This function is vulnerable to a race condition.  If the log file</span>
<span class="sd">   does not exist when the function is run, it will attempt to create the file</span>
<span class="sd">   as safely as possible (using ``O_CREAT``).  If two processes attempt to</span>
<span class="sd">   create the file at the same time, then one of them will fail.  In practice,</span>
<span class="sd">   this shouldn&#39;t really be a problem, but it might happen occassionally if two</span>
<span class="sd">   instances of cback3 run concurrently or if cback3 collides with logrotate or</span>
<span class="sd">   something.</span>

<span class="sd">   Args:</span>
<span class="sd">      options: Command-line options</span>

<span class="sd">   Returns:</span>
<span class="sd">       Path to logfile on disk</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">logfile</span> <span class="o">=</span> <span class="n">DEFAULT_LOGFILE</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">logfile</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">logfile</span>
   <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">logfile</span><span class="p">):</span>
      <span class="n">mode</span> <span class="o">=</span> <span class="n">DEFAULT_MODE</span> <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">options</span><span class="o">.</span><span class="n">mode</span>
      <span class="n">orig</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Per os.open(), &quot;When computing mode, the current umask value is first masked out&quot;</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="o">|</span><span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">os</span><span class="o">.</span><span class="n">O_APPEND</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
         <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s2">&quot;a+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
      <span class="k">finally</span><span class="p">:</span>
         <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">owner</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">owner</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span> <span class="o">=</span> <span class="n">getUidGid</span><span class="p">(</span><span class="n">DEFAULT_OWNERSHIP</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">DEFAULT_OWNERSHIP</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span> <span class="o">=</span> <span class="n">getUidGid</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">owner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">options</span><span class="o">.</span><span class="n">owner</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
         <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
      <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
   <span class="k">return</span> <span class="n">logfile</span>

<span class="k">def</span> <span class="nf">_setupFlowLogging</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Sets up flow logging.</span>
<span class="sd">   Args:</span>
<span class="sd">      logfile: Path to logfile on disk</span>
<span class="sd">      options: Command-line options</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">flowLogger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;CedarBackup3.log&quot;</span><span class="p">)</span>
   <span class="n">flowLogger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>    <span class="c1"># let the logger see all messages</span>
   <span class="n">_setupDiskFlowLogging</span><span class="p">(</span><span class="n">flowLogger</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
   <span class="n">_setupScreenFlowLogging</span><span class="p">(</span><span class="n">flowLogger</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_setupOutputLogging</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Sets up command output logging.</span>
<span class="sd">   Args:</span>
<span class="sd">      logfile: Path to logfile on disk</span>
<span class="sd">      options: Command-line options</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">outputLogger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;CedarBackup3.output&quot;</span><span class="p">)</span>
   <span class="n">outputLogger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>      <span class="c1"># let the logger see all messages</span>
   <span class="n">_setupDiskOutputLogging</span><span class="p">(</span><span class="n">outputLogger</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_setupDiskFlowLogging</span><span class="p">(</span><span class="n">flowLogger</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Sets up on-disk flow logging.</span>
<span class="sd">   Args:</span>
<span class="sd">      flowLogger: Python flow logger object</span>
<span class="sd">      logfile: Path to logfile on disk</span>
<span class="sd">      options: Command-line options</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="n">DISK_LOG_FORMAT</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="n">DATE_FORMAT</span><span class="p">)</span>
   <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
   <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
      <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
   <span class="n">flowLogger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_setupScreenFlowLogging</span><span class="p">(</span><span class="n">flowLogger</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Sets up on-screen flow logging.</span>
<span class="sd">   Args:</span>
<span class="sd">      flowLogger: Python flow logger object</span>
<span class="sd">      options: Command-line options</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="n">SCREEN_LOG_FORMAT</span><span class="p">)</span>
   <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">SCREEN_LOG_STREAM</span><span class="p">)</span>
   <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
      <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>  <span class="c1"># effectively turn it off</span>
   <span class="k">elif</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
   <span class="n">flowLogger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_setupDiskOutputLogging</span><span class="p">(</span><span class="n">outputLogger</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Sets up on-disk command output logging.</span>
<span class="sd">   Args:</span>
<span class="sd">      outputLogger: Python command output logger object</span>
<span class="sd">      logfile: Path to logfile on disk</span>
<span class="sd">      options: Command-line options</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="n">DISK_OUTPUT_FORMAT</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="n">DATE_FORMAT</span><span class="p">)</span>
   <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
   <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">debug</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
      <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>  <span class="c1"># effectively turn it off</span>
   <span class="n">outputLogger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>


<span class="c1">###############################</span>
<span class="c1"># setupPathResolver() function</span>
<span class="c1">###############################</span>

<div class="viewcode-block" id="setupPathResolver"><a class="viewcode-back" href="../../CedarBackup3.html#CedarBackup3.cli.setupPathResolver">[docs]</a><span class="k">def</span> <span class="nf">setupPathResolver</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Set up the path resolver singleton based on configuration.</span>

<span class="sd">   Cedar Backup&#39;s path resolver is implemented in terms of a singleton, the</span>
<span class="sd">   :any:`PathResolverSingleton` class.  This function takes options configuration,</span>
<span class="sd">   converts it into the dictionary form needed by the singleton, and then</span>
<span class="sd">   initializes the singleton.  After that, any function that needs to resolve</span>
<span class="sd">   the path of a command can use the singleton.</span>

<span class="sd">   Args:</span>
<span class="sd">      config (:any:`Config` object): Configuration</span>

<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">overrides</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">override</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">overrides</span><span class="p">:</span>
         <span class="n">mapping</span><span class="p">[</span><span class="n">override</span><span class="o">.</span><span class="n">command</span><span class="p">]</span> <span class="o">=</span> <span class="n">override</span><span class="o">.</span><span class="n">absolutePath</span>
   <span class="n">singleton</span> <span class="o">=</span> <span class="n">PathResolverSingleton</span><span class="p">()</span>
   <span class="n">singleton</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span></div>


<span class="c1">#########################################################################</span>
<span class="c1"># Options class definition</span>
<span class="c1">########################################################################</span>

<span class="nd">@total_ordering</span>
<div class="viewcode-block" id="Options"><a class="viewcode-back" href="../../CedarBackup3.html#CedarBackup3.cli.Options">[docs]</a><span class="k">class</span> <span class="nc">Options</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

   <span class="c1">######################</span>
   <span class="c1"># Class documentation</span>
   <span class="c1">######################</span>

   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Class representing command-line options for the cback3 script.</span>

<span class="sd">   The ``Options`` class is a Python object representation of the command-line</span>
<span class="sd">   options of the cback3 script.</span>

<span class="sd">   The object representation is two-way: a command line string or a list of</span>
<span class="sd">   command line arguments can be used to create an ``Options`` object, and then</span>
<span class="sd">   changes to the object can be propogated back to a list of command-line</span>
<span class="sd">   arguments or to a command-line string.  An ``Options`` object can even be</span>
<span class="sd">   created from scratch programmatically (if you have a need for that).</span>

<span class="sd">   There are two main levels of validation in the ``Options`` class.  The first</span>
<span class="sd">   is field-level validation.  Field-level validation comes into play when a</span>
<span class="sd">   given field in an object is assigned to or updated.  We use Python&#39;s</span>
<span class="sd">   ``property`` functionality to enforce specific validations on field values,</span>
<span class="sd">   and in some places we even use customized list classes to enforce</span>
<span class="sd">   validations on list members.  You should expect to catch a ``ValueError``</span>
<span class="sd">   exception when making assignments to fields if you are programmatically</span>
<span class="sd">   filling an object.</span>

<span class="sd">   The second level of validation is post-completion validation.  Certain</span>
<span class="sd">   validations don&#39;t make sense until an object representation of options is</span>
<span class="sd">   fully &quot;complete&quot;.  We don&#39;t want these validations to apply all of the time,</span>
<span class="sd">   because it would make building up a valid object from scratch a real pain.</span>
<span class="sd">   For instance, we might have to do things in the right order to keep from</span>
<span class="sd">   throwing exceptions, etc.</span>

<span class="sd">   All of these post-completion validations are encapsulated in the</span>
<span class="sd">   :any:`Options.validate` method.  This method can be called at any time by a</span>
<span class="sd">   client, and will always be called immediately after creating a ``Options``</span>
<span class="sd">   object from a command line and before exporting a ``Options`` object back to</span>
<span class="sd">   a command line.  This way, we get acceptable ease-of-use but we also don&#39;t</span>
<span class="sd">   accept or emit invalid command lines.</span>

<span class="sd">   *Note:* Lists within this class are &quot;unordered&quot; for equality comparisons.</span>

<span class="sd">   &quot;&quot;&quot;</span>

   <span class="c1">##############</span>
   <span class="c1"># Constructor</span>
   <span class="c1">##############</span>

<div class="viewcode-block" id="Options.__init__"><a class="viewcode-back" href="../../CedarBackup3.html#CedarBackup3.cli.Options.__init__">[docs]</a>   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argumentList</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">argumentString</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Initializes an options object.</span>

<span class="sd">      If you initialize the object without passing either ``argumentList`` or</span>
<span class="sd">      ``argumentString``, the object will be empty and will be invalid until it</span>
<span class="sd">      is filled in properly.</span>

<span class="sd">      No reference to the original arguments is saved off by this class.  Once</span>
<span class="sd">      the data has been parsed (successfully or not) this original information</span>
<span class="sd">      is discarded.</span>

<span class="sd">      The argument list is assumed to be a list of arguments, not including the</span>
<span class="sd">      name of the command, something like ``sys.argv[1:]``.  If you pass</span>
<span class="sd">      ``sys.argv`` instead, things are not going to work.</span>

<span class="sd">      The argument string will be parsed into an argument list by the</span>
<span class="sd">      :any:`util.splitCommandLine` function (see the documentation for that</span>
<span class="sd">      function for some important notes about its limitations).  There is an</span>
<span class="sd">      assumption that the resulting list will be equivalent to ``sys.argv[1:]``,</span>
<span class="sd">      just like ``argumentList``.</span>

<span class="sd">      Unless the ``validate`` argument is ``False``, the :any:`Options.validate`</span>
<span class="sd">      method will be called (with its default arguments) after successfully</span>
<span class="sd">      parsing any passed-in command line.  This validation ensures that</span>
<span class="sd">      appropriate actions, etc. have been specified.  Keep in mind that even if</span>
<span class="sd">      ``validate`` is ``False``, it might not be possible to parse the passed-in</span>
<span class="sd">      command line, so an exception might still be raised.</span>

<span class="sd">      *Note:* The command line format is specified by the ``_usage`` function.</span>
<span class="sd">      Call ``_usage`` to see a usage statement for the cback3 script.</span>

<span class="sd">      *Note:* It is strongly suggested that the ``validate`` option always be set</span>
<span class="sd">      to ``True`` (the default) unless there is a specific need to read in</span>
<span class="sd">      invalid command line arguments.</span>

<span class="sd">      Args:</span>
<span class="sd">         argumentList (List of arguments, i.e. ``sys.argv``): Command line for a program</span>
<span class="sd">         argumentString (String, i.e. &quot;cback3 --verbose stage store&quot;): Command line for a program</span>
<span class="sd">         validate (Boolean true/false): Validate the command line after parsing it</span>
<span class="sd">      Raises:</span>
<span class="sd">         getopt.GetoptError: If the command-line arguments could not be parsed</span>
<span class="sd">         ValueError: If the command-line arguments are invalid</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_help</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_full</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_managed</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_managedOnly</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_logfile</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_stacktrace</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_actions</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># initialize to an empty list; remainder are OK</span>
      <span class="k">if</span> <span class="n">argumentList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">argumentString</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Use either argumentList or argumentString, but not both.&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">argumentString</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentList</span> <span class="o">=</span> <span class="n">splitCommandLine</span><span class="p">(</span><span class="n">argumentString</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">argumentList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_parseArgumentList</span><span class="p">(</span><span class="n">argumentList</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span></div>


   <span class="c1">#########################</span>
   <span class="c1"># String representations</span>
   <span class="c1">#########################</span>

   <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Official string representation for class instance.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildArgumentString</span><span class="p">(</span><span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Informal string representation for class instance.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>


   <span class="c1">#############################</span>
   <span class="c1"># Standard comparison method</span>
   <span class="c1">#############################</span>

   <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Equals operator, implemented in terms of original Python 2 compare operator.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

   <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Less-than operator, implemented in terms of original Python 2 compare operator.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>

   <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Greater-than operator, implemented in terms of original Python 2 compare operator.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

   <span class="k">def</span> <span class="nf">__cmp__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Original Python 2 comparison operator.</span>
<span class="sd">      Lists within this class are &quot;unordered&quot; for equality comparisons.</span>
<span class="sd">      Args:</span>
<span class="sd">         other: Other object to compare to</span>
<span class="sd">      Returns:</span>
<span class="sd">          -1/0/1 depending on whether self is ``&lt;``, ``=`` or ``&gt;`` other</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">full</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">full</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">managed</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">managed</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">managed</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">managed</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">managedOnly</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">managedOnly</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">managedOnly</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">managedOnly</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">logfile</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">owner</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">owner</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">mode</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacktrace</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">stacktrace</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacktrace</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">stacktrace</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">actions</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">actions</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">return</span> <span class="mi">0</span>


   <span class="c1">#############</span>
   <span class="c1"># Properties</span>
   <span class="c1">#############</span>

   <span class="k">def</span> <span class="nf">_setHelp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the help flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_help</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_help</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getHelp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the help flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_help</span>

   <span class="k">def</span> <span class="nf">_setVersion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the version flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getVersion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the version flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span>

   <span class="k">def</span> <span class="nf">_setVerbose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the verbose flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getVerbose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the verbose flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span>

   <span class="k">def</span> <span class="nf">_setQuiet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the quiet flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getQuiet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the quiet flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span>

   <span class="k">def</span> <span class="nf">_setConfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the config parameter.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The config parameter must be a non-empty string.&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">value</span>

   <span class="k">def</span> <span class="nf">_getConfig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the config parameter.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span>

   <span class="k">def</span> <span class="nf">_setFull</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the full flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_full</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_full</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getFull</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the full flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_full</span>

   <span class="k">def</span> <span class="nf">_setManaged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the managed flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_managed</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_managed</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getManaged</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the managed flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managed</span>

   <span class="k">def</span> <span class="nf">_setManagedOnly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the managedOnly flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_managedOnly</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_managedOnly</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getManagedOnly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the managedOnly flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managedOnly</span>

   <span class="k">def</span> <span class="nf">_setLogfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the logfile parameter.</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If the value cannot be encoded properly</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The logfile parameter must be a non-empty string.&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_logfile</span> <span class="o">=</span> <span class="n">encodePath</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">_getLogfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the logfile parameter.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logfile</span>

   <span class="k">def</span> <span class="nf">_setOwner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the owner parameter.</span>
<span class="sd">      If not ``None``, the owner must be a ``(user,group)`` tuple or list.</span>
<span class="sd">      Strings (and inherited children of strings) are explicitly disallowed.</span>
<span class="sd">      The value will be normalized to a tuple.</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If the value is not valid</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must specify user and group tuple for owner parameter.&quot;</span><span class="p">)</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must specify user and group tuple for owner parameter.&quot;</span><span class="p">)</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;User and group tuple values must be non-empty strings.&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

   <span class="k">def</span> <span class="nf">_getOwner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the owner parameter.</span>
<span class="sd">      The parameter is a tuple of ``(user, group)``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span>

   <span class="k">def</span> <span class="nf">_setMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the mode parameter.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
               <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
         <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mode must be an octal integer &gt;= 0, i.e. 644.&quot;</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mode must be an octal integer &gt;= 0. i.e. 644.&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">value</span>

   <span class="k">def</span> <span class="nf">_getMode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the mode parameter.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span>

   <span class="k">def</span> <span class="nf">_setOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the output flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the output flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span>

   <span class="k">def</span> <span class="nf">_setDebug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the debug flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getDebug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the debug flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span>

   <span class="k">def</span> <span class="nf">_setStacktrace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the stacktrace flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_stacktrace</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_stacktrace</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getStacktrace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the stacktrace flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stacktrace</span>

   <span class="k">def</span> <span class="nf">_setDiagnostics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the diagnostics flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getDiagnostics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the diagnostics flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics</span>

   <span class="k">def</span> <span class="nf">_setActions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the actions list.</span>
<span class="sd">      We don&#39;t restrict the contents of actions.  They&#39;re validated somewhere else.</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If the value is not valid</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_actions</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="n">saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_actions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_actions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
         <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_actions</span> <span class="o">=</span> <span class="n">saved</span>
            <span class="k">raise</span> <span class="n">e</span>

   <span class="k">def</span> <span class="nf">_getActions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the actions list.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actions</span>

   <span class="n">help</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getHelp</span><span class="p">,</span> <span class="n">_setHelp</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line help (``-h,--help``) flag.&quot;</span><span class="p">)</span>
   <span class="n">version</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getVersion</span><span class="p">,</span> <span class="n">_setVersion</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line version (``-V,--version``) flag.&quot;</span><span class="p">)</span>
   <span class="n">verbose</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getVerbose</span><span class="p">,</span> <span class="n">_setVerbose</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line verbose (``-b,--verbose``) flag.&quot;</span><span class="p">)</span>
   <span class="n">quiet</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getQuiet</span><span class="p">,</span> <span class="n">_setQuiet</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line quiet (``-q,--quiet``) flag.&quot;</span><span class="p">)</span>
   <span class="n">config</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getConfig</span><span class="p">,</span> <span class="n">_setConfig</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line configuration file (``-c,--config``) parameter.&quot;</span><span class="p">)</span>
   <span class="n">full</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getFull</span><span class="p">,</span> <span class="n">_setFull</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line full-backup (``-f,--full``) flag.&quot;</span><span class="p">)</span>
   <span class="n">managed</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getManaged</span><span class="p">,</span> <span class="n">_setManaged</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line managed (``-M,--managed``) flag.&quot;</span><span class="p">)</span>
   <span class="n">managedOnly</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getManagedOnly</span><span class="p">,</span> <span class="n">_setManagedOnly</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line managed-only (``-N,--managed-only``) flag.&quot;</span><span class="p">)</span>
   <span class="n">logfile</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getLogfile</span><span class="p">,</span> <span class="n">_setLogfile</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line logfile (``-l,--logfile``) parameter.&quot;</span><span class="p">)</span>
   <span class="n">owner</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getOwner</span><span class="p">,</span> <span class="n">_setOwner</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line owner (``-o,--owner``) parameter, as tuple ``(user,group)``.&quot;</span><span class="p">)</span>
   <span class="n">mode</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getMode</span><span class="p">,</span> <span class="n">_setMode</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line mode (``-m,--mode``) parameter.&quot;</span><span class="p">)</span>
   <span class="n">output</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getOutput</span><span class="p">,</span> <span class="n">_setOutput</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line output (``-O,--output``) flag.&quot;</span><span class="p">)</span>
   <span class="n">debug</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getDebug</span><span class="p">,</span> <span class="n">_setDebug</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line debug (``-d,--debug``) flag.&quot;</span><span class="p">)</span>
   <span class="n">stacktrace</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getStacktrace</span><span class="p">,</span> <span class="n">_setStacktrace</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line stacktrace (``-s,--stack``) flag.&quot;</span><span class="p">)</span>
   <span class="n">diagnostics</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getDiagnostics</span><span class="p">,</span> <span class="n">_setDiagnostics</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line diagnostics (``-D,--diagnostics``) flag.&quot;</span><span class="p">)</span>
   <span class="n">actions</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getActions</span><span class="p">,</span> <span class="n">_setActions</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line actions list.&quot;</span><span class="p">)</span>


   <span class="c1">##################</span>
   <span class="c1"># Utility methods</span>
   <span class="c1">##################</span>

<div class="viewcode-block" id="Options.validate"><a class="viewcode-back" href="../../CedarBackup3.html#CedarBackup3.cli.Options.validate">[docs]</a>   <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Validates command-line options represented by the object.</span>

<span class="sd">      Unless ``--help`` or ``--version`` are supplied, at least one action must</span>
<span class="sd">      be specified.  Other validations (as for allowed values for particular</span>
<span class="sd">      options) will be taken care of at assignment time by the properties</span>
<span class="sd">      functionality.</span>

<span class="sd">      *Note:* The command line format is specified by the ``_usage`` function.</span>
<span class="sd">      Call ``_usage`` to see a usage statement for the cback3 script.</span>

<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If one of the validations fails</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one action must be specified.&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">managed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">managedOnly</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The --managed and --managed-only options may not be combined.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Options.buildArgumentList"><a class="viewcode-back" href="../../CedarBackup3.html#CedarBackup3.cli.Options.buildArgumentList">[docs]</a>   <span class="k">def</span> <span class="nf">buildArgumentList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Extracts options into a list of command line arguments.</span>

<span class="sd">      The original order of the various arguments (if, indeed, the object was</span>
<span class="sd">      initialized with a command-line) is not preserved in this generated</span>
<span class="sd">      argument list.   Besides that, the argument list is normalized to use the</span>
<span class="sd">      long option names (i.e. --version rather than -V).  The resulting list</span>
<span class="sd">      will be suitable for passing back to the constructor in the</span>
<span class="sd">      ``argumentList`` parameter.  Unlike :any:`buildArgumentString`, string</span>
<span class="sd">      arguments are not quoted here, because there is no need for it.</span>

<span class="sd">      Unless the ``validate`` parameter is ``False``, the :any:`Options.validate`</span>
<span class="sd">      method will be called (with its default arguments) against the</span>
<span class="sd">      options before extracting the command line.  If the options are not valid,</span>
<span class="sd">      then an argument list will not be extracted.</span>

<span class="sd">      *Note:* It is strongly suggested that the ``validate`` option always be set</span>
<span class="sd">      to ``True`` (the default) unless there is a specific need to extract an</span>
<span class="sd">      invalid command line.</span>

<span class="sd">      Args:</span>
<span class="sd">         validate (Boolean true/false): Validate the options before extracting the command line</span>
<span class="sd">      Returns:</span>
<span class="sd">          List representation of command-line arguments</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If options within the object are invalid</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
      <span class="n">argumentList</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_help</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--help&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--version&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--verbose&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--quiet&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--config&quot;</span><span class="p">)</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--full&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">managed</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--managed&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">managedOnly</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--managed-only&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--logfile&quot;</span><span class="p">)</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--owner&quot;</span><span class="p">)</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--mode&quot;</span><span class="p">)</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%o</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--output&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--debug&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacktrace</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--stack&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--diagnostics&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">:</span>
            <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">argumentList</span></div>

<div class="viewcode-block" id="Options.buildArgumentString"><a class="viewcode-back" href="../../CedarBackup3.html#CedarBackup3.cli.Options.buildArgumentString">[docs]</a>   <span class="k">def</span> <span class="nf">buildArgumentString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Extracts options into a string of command-line arguments.</span>

<span class="sd">      The original order of the various arguments (if, indeed, the object was</span>
<span class="sd">      initialized with a command-line) is not preserved in this generated</span>
<span class="sd">      argument string.   Besides that, the argument string is normalized to use</span>
<span class="sd">      the long option names (i.e. --version rather than -V) and to quote all</span>
<span class="sd">      string arguments with double quotes (``&quot;``).  The resulting string will be</span>
<span class="sd">      suitable for passing back to the constructor in the ``argumentString``</span>
<span class="sd">      parameter.</span>

<span class="sd">      Unless the ``validate`` parameter is ``False``, the :any:`Options.validate`</span>
<span class="sd">      method will be called (with its default arguments) against the options</span>
<span class="sd">      before extracting the command line.  If the options are not valid, then</span>
<span class="sd">      an argument string will not be extracted.</span>

<span class="sd">      *Note:* It is strongly suggested that the ``validate`` option always be set</span>
<span class="sd">      to ``True`` (the default) unless there is a specific need to extract an</span>
<span class="sd">      invalid command line.</span>

<span class="sd">      Args:</span>
<span class="sd">         validate (Boolean true/false): Validate the options before extracting the command line</span>
<span class="sd">      Returns:</span>
<span class="sd">          String representation of command-line arguments</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If options within the object are invalid</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
      <span class="n">argumentString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_help</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--help &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--version &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--verbose &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--quiet &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--config </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--full &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">managed</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--managed &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">managedOnly</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--managed-only &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--logfile </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--owner </span><span class="se">\&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--mode </span><span class="si">%o</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--output &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--debug &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacktrace</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--stack &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--diagnostics &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">:</span>
            <span class="n">argumentString</span> <span class="o">+=</span>  <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">action</span>
      <span class="k">return</span> <span class="n">argumentString</span></div>

   <span class="k">def</span> <span class="nf">_parseArgumentList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argumentList</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Internal method to parse a list of command-line arguments.</span>

<span class="sd">      Most of the validation we do here has to do with whether the arguments</span>
<span class="sd">      can be parsed and whether any values which exist are valid.  We don&#39;t do</span>
<span class="sd">      any validation as to whether required elements exist or whether elements</span>
<span class="sd">      exist in the proper combination (instead, that&#39;s the job of the</span>
<span class="sd">      :any:`validate` method).</span>

<span class="sd">      For any of the options which supply parameters, if the option is</span>
<span class="sd">      duplicated with long and short switches (i.e. ``-l`` and a ``--logfile``)</span>
<span class="sd">      then the long switch is used.  If the same option is duplicated with the</span>
<span class="sd">      same switch (long or short), then the last entry on the command line is</span>
<span class="sd">      used.</span>

<span class="sd">      Args:</span>
<span class="sd">         argumentList (List of arguments to a command, i.e. ``sys.argv[1:]``): List of arguments to a command</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If the argument list cannot be successfully parsed</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">switches</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>
      <span class="n">opts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="n">getopt</span><span class="o">.</span><span class="n">getopt</span><span class="p">(</span><span class="n">argumentList</span><span class="p">,</span> <span class="n">SHORT_SWITCHES</span><span class="p">,</span> <span class="n">LONG_SWITCHES</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>  <span class="c1"># push the switches into a hash</span>
         <span class="n">switches</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
      <span class="k">if</span> <span class="s2">&quot;-h&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--help&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-V&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--version&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-b&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--verbose&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-q&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--quiet&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-c&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">switches</span><span class="p">[</span><span class="s2">&quot;-c&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s2">&quot;--config&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">switches</span><span class="p">[</span><span class="s2">&quot;--config&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s2">&quot;-f&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--full&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">full</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-M&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--managed&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">managed</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-N&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--managed-only&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">managedOnly</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-l&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="n">switches</span><span class="p">[</span><span class="s2">&quot;-l&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s2">&quot;--logfile&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="n">switches</span><span class="p">[</span><span class="s2">&quot;--logfile&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s2">&quot;-o&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">switches</span><span class="p">[</span><span class="s2">&quot;-o&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">if</span> <span class="s2">&quot;--owner&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">switches</span><span class="p">[</span><span class="s2">&quot;--owner&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">if</span> <span class="s2">&quot;-m&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">switches</span><span class="p">[</span><span class="s2">&quot;-m&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s2">&quot;--mode&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">switches</span><span class="p">[</span><span class="s2">&quot;--mode&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s2">&quot;-O&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--output&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-d&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--debug&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-s&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--stack&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">stacktrace</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-D&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--diagnostics&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span> <span class="o">=</span> <span class="kc">True</span></div>


<span class="c1">#########################################################################</span>
<span class="c1"># Main routine</span>
<span class="c1">########################################################################</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
   <span class="n">result</span> <span class="o">=</span> <span class="n">cli</span><span class="p">()</span>
   <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Cedar Backup v3  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.9.
    </div>
  </body>
</html>
