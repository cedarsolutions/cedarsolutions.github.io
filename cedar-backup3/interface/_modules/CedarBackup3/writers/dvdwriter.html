<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>CedarBackup3.writers.dvdwriter &#8212; Cedar Backup v3  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="top" title="Cedar Backup v3  documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Cedar Backup v3  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for CedarBackup3.writers.dvdwriter</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: iso-8859-1 -*-</span>
<span class="c1"># vim: set ft=python ts=3 sw=3 expandtab:</span>
<span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
<span class="c1">#</span>
<span class="c1">#              C E D A R</span>
<span class="c1">#          S O L U T I O N S       &quot;Software done right.&quot;</span>
<span class="c1">#           S O F T W A R E</span>
<span class="c1">#</span>
<span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2007-2008,2010,2015 Kenneth J. Pronovici.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This program is free software; you can redistribute it and/or</span>
<span class="c1"># modify it under the terms of the GNU General Public License,</span>
<span class="c1"># Version 2, as published by the Free Software Foundation.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="c1">#</span>
<span class="c1"># Copies of the GNU General Public License are available from</span>
<span class="c1"># the Free Software Foundation website, http://www.gnu.org/.</span>
<span class="c1">#</span>
<span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
<span class="c1">#</span>
<span class="c1"># Author   : Kenneth J. Pronovici &lt;pronovic@ieee.org&gt;</span>
<span class="c1"># Language : Python 3 (&gt;= 3.4)</span>
<span class="c1"># Project  : Cedar Backup, release 3</span>
<span class="c1"># Purpose  : Provides functionality related to DVD writer devices.</span>
<span class="c1">#</span>
<span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

<span class="c1">########################################################################</span>
<span class="c1"># Module documentation</span>
<span class="c1">########################################################################</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Provides functionality related to DVD writer devices.</span>

<span class="sd">Module Attributes</span>
<span class="sd">=================</span>

<span class="sd">Attributes:</span>
<span class="sd">   MEDIA_DVDPLUSR: Constant representing DVD+R media</span>
<span class="sd">   MEDIA_DVDPLUSRW: Constant representing DVD+RW media</span>

<span class="sd">:author: Kenneth J. Pronovici &lt;pronovic@ieee.org&gt;</span>
<span class="sd">:author: Dmitry Rutsky &lt;rutsky@inbox.ru&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">########################################################################</span>
<span class="c1"># Imported modules</span>
<span class="c1">########################################################################</span>

<span class="c1"># System modules</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># Cedar Backup modules</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.writers.util</span> <span class="k">import</span> <span class="n">IsoImage</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.util</span> <span class="k">import</span> <span class="n">resolveCommand</span><span class="p">,</span> <span class="n">executeCommand</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.util</span> <span class="k">import</span> <span class="n">convertSize</span><span class="p">,</span> <span class="n">displayBytes</span><span class="p">,</span> <span class="n">encodePath</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.util</span> <span class="k">import</span> <span class="n">UNIT_SECTORS</span><span class="p">,</span> <span class="n">UNIT_BYTES</span><span class="p">,</span> <span class="n">UNIT_GBYTES</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.writers.util</span> <span class="k">import</span> <span class="n">validateDevice</span><span class="p">,</span> <span class="n">validateDriveSpeed</span>


<span class="c1">########################################################################</span>
<span class="c1"># Module-wide constants and variables</span>
<span class="c1">########################################################################</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;CedarBackup3.log.writers.dvdwriter&quot;</span><span class="p">)</span>

<span class="n">MEDIA_DVDPLUSR</span>  <span class="o">=</span> <span class="mi">1</span>
<span class="n">MEDIA_DVDPLUSRW</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">GROWISOFS_COMMAND</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;growisofs&quot;</span><span class="p">,</span> <span class="p">]</span>
<span class="n">EJECT_COMMAND</span>     <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;eject&quot;</span><span class="p">,</span> <span class="p">]</span>


<span class="c1">########################################################################</span>
<span class="c1"># MediaDefinition class definition</span>
<span class="c1">########################################################################</span>

<div class="viewcode-block" id="MediaDefinition"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.MediaDefinition">[docs]</a><span class="k">class</span> <span class="nc">MediaDefinition</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Class encapsulating information about DVD media definitions.</span>

<span class="sd">   The following media types are accepted:</span>

<span class="sd">         - ``MEDIA_DVDPLUSR``: DVD+R media (4.4 GB capacity)</span>
<span class="sd">         - ``MEDIA_DVDPLUSRW``: DVD+RW media (4.4 GB capacity)</span>

<span class="sd">   Note that the capacity attribute returns capacity in terms of ISO sectors</span>
<span class="sd">   (``util.ISO_SECTOR_SIZE)``.  This is for compatibility with the CD writer</span>
<span class="sd">   functionality.</span>

<span class="sd">   The capacities are 4.4 GB because Cedar Backup deals in &quot;true&quot; gigabytes</span>
<span class="sd">   of 1024*1024*1024 bytes per gigabyte.</span>

<span class="sd">   &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MediaDefinition.__init__"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.MediaDefinition.__init__">[docs]</a>   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mediaType</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Creates a media definition for the indicated media type.</span>
<span class="sd">      Args:</span>
<span class="sd">         mediaType: Type of the media, as discussed above</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If the media type is unknown or unsupported</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_mediaType</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rewritable</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_capacity</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_setValues</span><span class="p">(</span><span class="n">mediaType</span><span class="p">)</span></div>

   <span class="k">def</span> <span class="nf">_setValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mediaType</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Sets values based on media type.</span>
<span class="sd">      Args:</span>
<span class="sd">         mediaType: Type of the media, as discussed above</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If the media type is unknown or unsupported</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">mediaType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">MEDIA_DVDPLUSR</span><span class="p">,</span> <span class="n">MEDIA_DVDPLUSRW</span><span class="p">,</span> <span class="p">]:</span>
         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid media type </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">mediaType</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_mediaType</span> <span class="o">=</span> <span class="n">mediaType</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mediaType</span> <span class="o">==</span> <span class="n">MEDIA_DVDPLUSR</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_rewritable</span> <span class="o">=</span> <span class="kc">False</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_capacity</span> <span class="o">=</span> <span class="n">convertSize</span><span class="p">(</span><span class="mf">4.4</span><span class="p">,</span> <span class="n">UNIT_GBYTES</span><span class="p">,</span> <span class="n">UNIT_SECTORS</span><span class="p">)</span>   <span class="c1"># 4.4 &quot;true&quot; GB = 4.7 &quot;marketing&quot; GB</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mediaType</span> <span class="o">==</span> <span class="n">MEDIA_DVDPLUSRW</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_rewritable</span> <span class="o">=</span> <span class="kc">True</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_capacity</span> <span class="o">=</span> <span class="n">convertSize</span><span class="p">(</span><span class="mf">4.4</span><span class="p">,</span> <span class="n">UNIT_GBYTES</span><span class="p">,</span> <span class="n">UNIT_SECTORS</span><span class="p">)</span>   <span class="c1"># 4.4 &quot;true&quot; GB = 4.7 &quot;marketing&quot; GB</span>

   <span class="k">def</span> <span class="nf">_getMediaType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the media type value.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mediaType</span>

   <span class="k">def</span> <span class="nf">_getRewritable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the rewritable flag value.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewritable</span>

   <span class="k">def</span> <span class="nf">_getCapacity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the capacity value.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capacity</span>

   <span class="n">mediaType</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getMediaType</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Configured media type.&quot;</span><span class="p">)</span>
   <span class="n">rewritable</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getRewritable</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Boolean indicating whether the media is rewritable.&quot;</span><span class="p">)</span>
   <span class="n">capacity</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getCapacity</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Total capacity of media in 2048-byte sectors.&quot;</span><span class="p">)</span></div>


<span class="c1">########################################################################</span>
<span class="c1"># MediaCapacity class definition</span>
<span class="c1">########################################################################</span>

<div class="viewcode-block" id="MediaCapacity"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.MediaCapacity">[docs]</a><span class="k">class</span> <span class="nc">MediaCapacity</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Class encapsulating information about DVD media capacity.</span>

<span class="sd">   Space used and space available do not include any information about media</span>
<span class="sd">   lead-in or other overhead.</span>

<span class="sd">   &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MediaCapacity.__init__"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.MediaCapacity.__init__">[docs]</a>   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bytesUsed</span><span class="p">,</span> <span class="n">bytesAvailable</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Initializes a capacity object.</span>

<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If the bytes used and available values are not floats</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_bytesUsed</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bytesUsed</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_bytesAvailable</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bytesAvailable</span><span class="p">)</span></div>

   <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Informal string representation for class instance.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="s2">&quot;utilized </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%.2f%%</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">displayBytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bytesUsed</span><span class="p">),</span> <span class="n">displayBytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">totalCapacity</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">utilized</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">_getBytesUsed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the bytes-used value.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bytesUsed</span>

   <span class="k">def</span> <span class="nf">_getBytesAvailable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target available to get the bytes-available value.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bytesAvailable</span>

   <span class="k">def</span> <span class="nf">_getTotalCapacity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target to get the total capacity (used + available).</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytesUsed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytesAvailable</span>

   <span class="k">def</span> <span class="nf">_getUtilized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target to get the percent of capacity which is utilized.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytesAvailable</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
         <span class="k">return</span> <span class="mf">100.0</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytesUsed</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
         <span class="k">return</span> <span class="mf">0.0</span>
      <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bytesUsed</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalCapacity</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>

   <span class="n">bytesUsed</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getBytesUsed</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Space used on disc, in bytes.&quot;</span><span class="p">)</span>
   <span class="n">bytesAvailable</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getBytesAvailable</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Space available on disc, in bytes.&quot;</span><span class="p">)</span>
   <span class="n">totalCapacity</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getTotalCapacity</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Total capacity of the disc, in bytes.&quot;</span><span class="p">)</span>
   <span class="n">utilized</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getUtilized</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Percentage of the total capacity which is utilized.&quot;</span><span class="p">)</span></div>


<span class="c1">########################################################################</span>
<span class="c1"># _ImageProperties class definition</span>
<span class="c1">########################################################################</span>

<span class="k">class</span> <span class="nc">_ImageProperties</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Simple value object to hold image properties for ``DvdWriter``.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">newDisc</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">mediaLabel</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="kc">None</span>     <span class="c1"># dict mapping path to graft point</span>


<span class="c1">########################################################################</span>
<span class="c1"># DvdWriter class definition</span>
<span class="c1">########################################################################</span>

<div class="viewcode-block" id="DvdWriter"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.DvdWriter">[docs]</a><span class="k">class</span> <span class="nc">DvdWriter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

   <span class="c1">######################</span>
   <span class="c1"># Class documentation</span>
   <span class="c1">######################</span>

   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Class representing a device that knows how to write some kinds of DVD media.</span>

<span class="sd">   **Summary**</span>

<span class="sd">   This is a class representing a device that knows how to write some kinds</span>
<span class="sd">   of DVD media.  It provides common operations for the device, such as</span>
<span class="sd">   ejecting the media and writing data to the media.</span>

<span class="sd">   This class is implemented in terms of the ``eject`` and ``growisofs``</span>
<span class="sd">   utilities, all of which should be available on most UN*X platforms.</span>

<span class="sd">   **Image Writer Interface**</span>

<span class="sd">   The following methods make up the &quot;image writer&quot; interface shared</span>
<span class="sd">   with other kinds of writers::</span>

<span class="sd">      __init__</span>
<span class="sd">      initializeImage()</span>
<span class="sd">      addImageEntry()</span>
<span class="sd">      writeImage()</span>
<span class="sd">      setImageNewDisc()</span>
<span class="sd">      retrieveCapacity()</span>
<span class="sd">      getEstimatedImageSize()</span>

<span class="sd">   Only these methods will be used by other Cedar Backup functionality</span>
<span class="sd">   that expects a compatible image writer.</span>

<span class="sd">   The media attribute is also assumed to be available.</span>

<span class="sd">   Unlike the ``CdWriter``, the ``DvdWriter`` can only operate in terms of</span>
<span class="sd">   filesystem devices, not SCSI devices.  So, although the constructor</span>
<span class="sd">   interface accepts a SCSI device parameter for the sake of compatibility,</span>
<span class="sd">   it&#39;s not used.</span>

<span class="sd">   **Media Types**</span>

<span class="sd">   This class knows how to write to DVD+R and DVD+RW media, represented</span>
<span class="sd">   by the following constants:</span>

<span class="sd">      - ``MEDIA_DVDPLUSR``: DVD+R media (4.4 GB capacity)</span>
<span class="sd">      - ``MEDIA_DVDPLUSRW``: DVD+RW media (4.4 GB capacity)</span>

<span class="sd">   The difference is that DVD+RW media can be rewritten, while DVD+R media</span>
<span class="sd">   cannot be (although at present, ``DvdWriter`` does not really</span>
<span class="sd">   differentiate between rewritable and non-rewritable media).</span>

<span class="sd">   The capacities are 4.4 GB because Cedar Backup deals in &quot;true&quot; gigabytes</span>
<span class="sd">   of 1024*1024*1024 bytes per gigabyte.</span>

<span class="sd">   The underlying ``growisofs`` utility does support other kinds of media</span>
<span class="sd">   (including DVD-R, DVD-RW and BlueRay) which work somewhat differently</span>
<span class="sd">   than standard DVD+R and DVD+RW media.  I don&#39;t support these other kinds</span>
<span class="sd">   of media because I haven&#39;t had any opportunity to work with them.  The</span>
<span class="sd">   same goes for dual-layer media of any type.</span>

<span class="sd">   **Device Attributes vs. Media Attributes**</span>

<span class="sd">   As with the cdwriter functionality, a given dvdwriter instance has two</span>
<span class="sd">   different kinds of attributes associated with it.  I call these device</span>
<span class="sd">   attributes and media attributes.</span>

<span class="sd">   Device attributes are things which can be determined without looking at</span>
<span class="sd">   the media.  Media attributes are attributes which vary depending on the</span>
<span class="sd">   state of the media.  In general, device attributes are available via</span>
<span class="sd">   instance variables and are constant over the life of an object, while</span>
<span class="sd">   media attributes can be retrieved through method calls.</span>

<span class="sd">   Compared to cdwriters, dvdwriters have very few attributes.  This is due</span>
<span class="sd">   to differences between the way ``growisofs`` works relative to</span>
<span class="sd">   ``cdrecord``.</span>

<span class="sd">   **Media Capacity**</span>

<span class="sd">   One major difference between the ``cdrecord``/``mkisofs`` utilities used by</span>
<span class="sd">   the cdwriter class and the ``growisofs`` utility used here is that the</span>
<span class="sd">   process of estimating remaining capacity and image size is more</span>
<span class="sd">   straightforward with ``cdrecord``/``mkisofs`` than with ``growisofs``.</span>

<span class="sd">   In this class, remaining capacity is calculated by asking doing a dry run</span>
<span class="sd">   of ``growisofs`` and grabbing some information from the output of that</span>
<span class="sd">   command.  Image size is estimated by asking the ``IsoImage`` class for an</span>
<span class="sd">   estimate and then adding on a &quot;fudge factor&quot; determined through</span>
<span class="sd">   experimentation.</span>

<span class="sd">   **Testing**</span>

<span class="sd">   It&#39;s rather difficult to test this code in an automated fashion, even if</span>
<span class="sd">   you have access to a physical DVD writer drive.  It&#39;s even more difficult</span>
<span class="sd">   to test it if you are running on some build daemon (think of a Debian</span>
<span class="sd">   autobuilder) which can&#39;t be expected to have any hardware or any media</span>
<span class="sd">   that you could write to.</span>

<span class="sd">   Because of this, some of the implementation below is in terms of static</span>
<span class="sd">   methods that are supposed to take defined actions based on their</span>
<span class="sd">   arguments.  Public methods are then implemented in terms of a series of</span>
<span class="sd">   calls to simplistic static methods.  This way, we can test as much as</span>
<span class="sd">   possible of the &quot;difficult&quot; functionality via testing the static methods,</span>
<span class="sd">   while hoping that if the static methods are called appropriately, things</span>
<span class="sd">   will work properly.  It&#39;s not perfect, but it&#39;s much better than no</span>
<span class="sd">   testing at all.</span>

<span class="sd">   &quot;&quot;&quot;</span>

   <span class="c1">##############</span>
   <span class="c1"># Constructor</span>
   <span class="c1">##############</span>

<div class="viewcode-block" id="DvdWriter.__init__"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.DvdWriter.__init__">[docs]</a>   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">scsiId</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">driveSpeed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">mediaType</span><span class="o">=</span><span class="n">MEDIA_DVDPLUSRW</span><span class="p">,</span> <span class="n">noEject</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">refreshMediaDelay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ejectDelay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">unittest</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Initializes a DVD writer object.</span>

<span class="sd">      Since ``growisofs`` can only address devices using the device path (i.e.</span>
<span class="sd">      ``/dev/dvd``), the hardware id will always be set based on the device.  If</span>
<span class="sd">      passed in, it will be saved for reference purposes only.</span>

<span class="sd">      We have no way to query the device to ask whether it has a tray or can be</span>
<span class="sd">      safely opened and closed.  So, the ``noEject`` flag is used to set these</span>
<span class="sd">      values.  If ``noEject=False``, then we assume a tray exists and open/close</span>
<span class="sd">      is safe.  If ``noEject=True``, then we assume that there is no tray and</span>
<span class="sd">      open/close is not safe.</span>

<span class="sd">      The SCSI id, if provided, is in the form ``[&lt;method&gt;:]scsibus,target,lun``.</span>

<span class="sd">      *Note:* The ``unittest`` parameter should never be set to ``True``</span>
<span class="sd">      outside of Cedar Backup code.  It is intended for use in unit testing</span>
<span class="sd">      Cedar Backup internals and has no other sensible purpose.</span>

<span class="sd">      Args:</span>
<span class="sd">         device: Absolute path to the writer filesystem device, like ``/dev/dvd``</span>
<span class="sd">         scsiId: SCSI id for the device (optional, for reference only)</span>
<span class="sd">         driveSpeed: Speed at which the drive writes, like 2 for a 2x device, or None for device default</span>
<span class="sd">         mediaType: Type of the media that is assumed to be in the drive</span>
<span class="sd">         noEject (Boolean true/false): Tells Cedar Backup that the device cannot safely be ejected</span>
<span class="sd">         refreshMediaDelay (Integer &gt;= 0): Refresh media delay to use, if any</span>
<span class="sd">         ejectDelay (Integer &gt;= 0): Eject delay to use, if any</span>
<span class="sd">         unittest (Boolean true/false): Turns off certain validations, for use in unit testing</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If the device is not valid for some reason</span>
<span class="sd">         ValueError: If the SCSI id is not in a valid form</span>
<span class="sd">         ValueError: If the drive speed is not an integer &gt;= 1</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">scsiId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;SCSI id [</span><span class="si">%s</span><span class="s2">] will be ignored by DvdWriter.&quot;</span><span class="p">,</span> <span class="n">scsiId</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># optionally filled in by initializeImage()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="n">validateDevice</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">unittest</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_scsiId</span> <span class="o">=</span> <span class="n">scsiId</span>  <span class="c1"># not validated, because it&#39;s just for reference</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_driveSpeed</span> <span class="o">=</span> <span class="n">validateDriveSpeed</span><span class="p">(</span><span class="n">driveSpeed</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_media</span> <span class="o">=</span> <span class="n">MediaDefinition</span><span class="p">(</span><span class="n">mediaType</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_refreshMediaDelay</span> <span class="o">=</span> <span class="n">refreshMediaDelay</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_ejectDelay</span> <span class="o">=</span> <span class="n">ejectDelay</span>
      <span class="k">if</span> <span class="n">noEject</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_deviceHasTray</span> <span class="o">=</span> <span class="kc">False</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_deviceCanEject</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_deviceHasTray</span> <span class="o">=</span> <span class="kc">True</span>   <span class="c1"># just assume</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_deviceCanEject</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># just assume</span></div>


   <span class="c1">#############</span>
   <span class="c1"># Properties</span>
   <span class="c1">#############</span>

   <span class="k">def</span> <span class="nf">_getDevice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the device value.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span>

   <span class="k">def</span> <span class="nf">_getScsiId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the SCSI id value.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scsiId</span>

   <span class="k">def</span> <span class="nf">_getHardwareId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the hardware id value.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span>

   <span class="k">def</span> <span class="nf">_getDriveSpeed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the drive speed.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driveSpeed</span>

   <span class="k">def</span> <span class="nf">_getMedia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the media description.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_media</span>

   <span class="k">def</span> <span class="nf">_getDeviceHasTray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the device-has-tray flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deviceHasTray</span>

   <span class="k">def</span> <span class="nf">_getDeviceCanEject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the device-can-eject flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deviceCanEject</span>

   <span class="k">def</span> <span class="nf">_getRefreshMediaDelay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the configured refresh media delay, in seconds.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refreshMediaDelay</span>

   <span class="k">def</span> <span class="nf">_getEjectDelay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the configured eject delay, in seconds.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ejectDelay</span>

   <span class="n">device</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getDevice</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Filesystem device name for this writer.&quot;</span><span class="p">)</span>
   <span class="n">scsiId</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getScsiId</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;SCSI id for the device (saved for reference only).&quot;</span><span class="p">)</span>
   <span class="n">hardwareId</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getHardwareId</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Hardware id for this writer (always the device path).&quot;</span><span class="p">)</span>
   <span class="n">driveSpeed</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getDriveSpeed</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Speed at which the drive writes.&quot;</span><span class="p">)</span>
   <span class="n">media</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getMedia</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Definition of media that is expected to be in the device.&quot;</span><span class="p">)</span>
   <span class="n">deviceHasTray</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getDeviceHasTray</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Indicates whether the device has a media tray.&quot;</span><span class="p">)</span>
   <span class="n">deviceCanEject</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getDeviceCanEject</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Indicates whether the device supports ejecting its media.&quot;</span><span class="p">)</span>
   <span class="n">refreshMediaDelay</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getRefreshMediaDelay</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Refresh media delay, in seconds.&quot;</span><span class="p">)</span>
   <span class="n">ejectDelay</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getEjectDelay</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Eject delay, in seconds.&quot;</span><span class="p">)</span>


   <span class="c1">#################################################</span>
   <span class="c1"># Methods related to device and media attributes</span>
   <span class="c1">#################################################</span>

<div class="viewcode-block" id="DvdWriter.isRewritable"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.DvdWriter.isRewritable">[docs]</a>   <span class="k">def</span> <span class="nf">isRewritable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Indicates whether the media is rewritable per configuration.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_media</span><span class="o">.</span><span class="n">rewritable</span></div>

<div class="viewcode-block" id="DvdWriter.retrieveCapacity"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.DvdWriter.retrieveCapacity">[docs]</a>   <span class="k">def</span> <span class="nf">retrieveCapacity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entireDisc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Retrieves capacity for the current media in terms of a ``MediaCapacity``</span>
<span class="sd">      object.</span>

<span class="sd">      If ``entireDisc`` is passed in as ``True``, the capacity will be for the</span>
<span class="sd">      entire disc, as if it were to be rewritten from scratch.  The same will</span>
<span class="sd">      happen if the disc can&#39;t be read for some reason. Otherwise, the capacity</span>
<span class="sd">      will be calculated by subtracting the sectors currently used on the disc,</span>
<span class="sd">      as reported by ``growisofs`` itself.</span>

<span class="sd">      Args:</span>
<span class="sd">         entireDisc (Boolean true/false): Indicates whether to return capacity for entire disc</span>
<span class="sd">      Returns:</span>
<span class="sd">          ``MediaCapacity`` object describing the capacity of the media</span>

<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If there is a problem parsing the ``growisofs`` output</span>
<span class="sd">         IOError: If the media could not be read for some reason</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">sectorsUsed</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">entireDisc</span><span class="p">:</span>
         <span class="n">sectorsUsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieveSectorsUsed</span><span class="p">()</span>
      <span class="n">sectorsAvailable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_media</span><span class="o">.</span><span class="n">capacity</span> <span class="o">-</span> <span class="n">sectorsUsed</span>  <span class="c1"># both are in sectors</span>
      <span class="n">bytesUsed</span> <span class="o">=</span> <span class="n">convertSize</span><span class="p">(</span><span class="n">sectorsUsed</span><span class="p">,</span> <span class="n">UNIT_SECTORS</span><span class="p">,</span> <span class="n">UNIT_BYTES</span><span class="p">)</span>
      <span class="n">bytesAvailable</span> <span class="o">=</span> <span class="n">convertSize</span><span class="p">(</span><span class="n">sectorsAvailable</span><span class="p">,</span> <span class="n">UNIT_SECTORS</span><span class="p">,</span> <span class="n">UNIT_BYTES</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">MediaCapacity</span><span class="p">(</span><span class="n">bytesUsed</span><span class="p">,</span> <span class="n">bytesAvailable</span><span class="p">)</span></div>


   <span class="c1">#######################################################</span>
   <span class="c1"># Methods used for working with the internal ISO image</span>
   <span class="c1">#######################################################</span>

<div class="viewcode-block" id="DvdWriter.initializeImage"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.DvdWriter.initializeImage">[docs]</a>   <span class="k">def</span> <span class="nf">initializeImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newDisc</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">,</span> <span class="n">mediaLabel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Initializes the writer&#39;s associated ISO image.</span>

<span class="sd">      This method initializes the ``image`` instance variable so that the caller</span>
<span class="sd">      can use the ``addImageEntry`` method.  Once entries have been added, the</span>
<span class="sd">      ``writeImage`` method can be called with no arguments.</span>

<span class="sd">      Args:</span>
<span class="sd">         newDisc (Boolean true/false): Indicates whether the disc should be re-initialized</span>
<span class="sd">         tmpdir (String representing a directory path on disk): Temporary directory to use if needed</span>
<span class="sd">         mediaLabel (String, no more than 25 characters long): Media label to be applied to the image, if any</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">_ImageProperties</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">newDisc</span> <span class="o">=</span> <span class="n">newDisc</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="n">encodePath</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">mediaLabel</span> <span class="o">=</span> <span class="n">mediaLabel</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># mapping from path to graft point (if any)</span></div>

<div class="viewcode-block" id="DvdWriter.addImageEntry"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.DvdWriter.addImageEntry">[docs]</a>   <span class="k">def</span> <span class="nf">addImageEntry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">graftPoint</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Adds a filepath entry to the writer&#39;s associated ISO image.</span>

<span class="sd">      The contents of the filepath -- but not the path itself -- will be added</span>
<span class="sd">      to the image at the indicated graft point.  If you don&#39;t want to use a</span>
<span class="sd">      graft point, just pass ``None``.</span>

<span class="sd">      *Note:* Before calling this method, you must call :any:`initializeImage`.</span>

<span class="sd">      Args:</span>
<span class="sd">         path (String representing a path on disk): File or directory to be added to the image</span>
<span class="sd">         graftPoint (String representing a graft point path, as described above): Graft point to be used when adding this entry</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If initializeImage() was not previously called</span>
<span class="sd">         ValueError: If the path is not a valid file or directory</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must call initializeImage() before using this method.&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Path [</span><span class="si">%s</span><span class="s2">] does not exist.&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">graftPoint</span></div>

<div class="viewcode-block" id="DvdWriter.setImageNewDisc"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.DvdWriter.setImageNewDisc">[docs]</a>   <span class="k">def</span> <span class="nf">setImageNewDisc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newDisc</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Resets (overrides) the newDisc flag on the internal image.</span>
<span class="sd">      Args:</span>
<span class="sd">         newDisc: New disc flag to set</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If initializeImage() was not previously called</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must call initializeImage() before using this method.&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">newDisc</span> <span class="o">=</span> <span class="n">newDisc</span></div>

<div class="viewcode-block" id="DvdWriter.getEstimatedImageSize"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.DvdWriter.getEstimatedImageSize">[docs]</a>   <span class="k">def</span> <span class="nf">getEstimatedImageSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Gets the estimated size of the image associated with the writer.</span>

<span class="sd">      This is an estimate and is conservative.  The actual image could be as</span>
<span class="sd">      much as 450 blocks (sectors) smaller under some circmstances.</span>

<span class="sd">      Returns:</span>
<span class="sd">          Estimated size of the image, in bytes</span>

<span class="sd">      Raises:</span>
<span class="sd">         IOError: If there is a problem calling ``mkisofs``</span>
<span class="sd">         ValueError: If initializeImage() was not previously called</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must call initializeImage() before using this method.&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">DvdWriter</span><span class="o">.</span><span class="n">_getEstimatedImageSize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">entries</span><span class="p">)</span></div>


   <span class="c1">######################################</span>
   <span class="c1"># Methods which expose device actions</span>
   <span class="c1">######################################</span>

<div class="viewcode-block" id="DvdWriter.openTray"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.DvdWriter.openTray">[docs]</a>   <span class="k">def</span> <span class="nf">openTray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Opens the device&#39;s tray and leaves it open.</span>

<span class="sd">      This only works if the device has a tray and supports ejecting its media.</span>
<span class="sd">      We have no way to know if the tray is currently open or closed, so we</span>
<span class="sd">      just send the appropriate command and hope for the best.  If the device</span>
<span class="sd">      does not have a tray or does not support ejecting its media, then we do</span>
<span class="sd">      nothing.</span>

<span class="sd">      Starting with Debian wheezy on my backup hardware, I started seeing</span>
<span class="sd">      consistent problems with the eject command.  I couldn&#39;t tell whether</span>
<span class="sd">      these problems were due to the device management system or to the new</span>
<span class="sd">      kernel (3.2.0).  Initially, I saw simple eject failures, possibly because</span>
<span class="sd">      I was opening and closing the tray too quickly.  I worked around that</span>
<span class="sd">      behavior with the new ejectDelay flag.</span>

<span class="sd">      Later, I sometimes ran into issues after writing an image to a disc:</span>
<span class="sd">      eject would give errors like &quot;unable to eject, last error: Inappropriate</span>
<span class="sd">      ioctl for device&quot;.  Various sources online (like Ubuntu bug #875543)</span>
<span class="sd">      suggested that the drive was being locked somehow, and that the</span>
<span class="sd">      workaround was to run &#39;eject -i off&#39; to unlock it.  Sure enough, that</span>
<span class="sd">      fixed the problem for me, so now it&#39;s a normal error-handling strategy.</span>

<span class="sd">      Raises:</span>
<span class="sd">         IOError: If there is an error talking to the device</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deviceHasTray</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deviceCanEject</span><span class="p">:</span>
         <span class="n">command</span> <span class="o">=</span> <span class="n">resolveCommand</span><span class="p">(</span><span class="n">EJECT_COMMAND</span><span class="p">)</span>
         <span class="n">args</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="p">]</span>
         <span class="n">result</span> <span class="o">=</span> <span class="n">executeCommand</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
         <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Eject failed; attempting kludge of unlocking the tray before retrying.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unlockTray</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">executeCommand</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Error (</span><span class="si">%d</span><span class="s2">) executing eject command to open tray (failed even after unlocking tray).&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Kludge was apparently successful.&quot;</span><span class="p">)</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ejectDelay</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Per configuration, sleeping </span><span class="si">%d</span><span class="s2"> seconds after opening tray.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ejectDelay</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ejectDelay</span><span class="p">)</span></div>

<div class="viewcode-block" id="DvdWriter.unlockTray"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.DvdWriter.unlockTray">[docs]</a>   <span class="k">def</span> <span class="nf">unlockTray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Unlocks the device&#39;s tray via &#39;eject -i off&#39;.</span>
<span class="sd">      Raises:</span>
<span class="sd">         IOError: If there is an error talking to the device</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">command</span> <span class="o">=</span> <span class="n">resolveCommand</span><span class="p">(</span><span class="n">EJECT_COMMAND</span><span class="p">)</span>
      <span class="n">args</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="p">]</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">executeCommand</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Error (</span><span class="si">%d</span><span class="s2">) executing eject command to unlock tray.&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="DvdWriter.closeTray"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.DvdWriter.closeTray">[docs]</a>   <span class="k">def</span> <span class="nf">closeTray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Closes the device&#39;s tray.</span>

<span class="sd">      This only works if the device has a tray and supports ejecting its media.</span>
<span class="sd">      We have no way to know if the tray is currently open or closed, so we</span>
<span class="sd">      just send the appropriate command and hope for the best.  If the device</span>
<span class="sd">      does not have a tray or does not support ejecting its media, then we do</span>
<span class="sd">      nothing.</span>

<span class="sd">      Raises:</span>
<span class="sd">         IOError: If there is an error talking to the device</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deviceHasTray</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deviceCanEject</span><span class="p">:</span>
         <span class="n">command</span> <span class="o">=</span> <span class="n">resolveCommand</span><span class="p">(</span><span class="n">EJECT_COMMAND</span><span class="p">)</span>
         <span class="n">args</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="p">]</span>
         <span class="n">result</span> <span class="o">=</span> <span class="n">executeCommand</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
         <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Error (</span><span class="si">%d</span><span class="s2">) executing eject command to close tray.&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="DvdWriter.refreshMedia"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.DvdWriter.refreshMedia">[docs]</a>   <span class="k">def</span> <span class="nf">refreshMedia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Opens and then immediately closes the device&#39;s tray, to refresh the</span>
<span class="sd">      device&#39;s idea of the media.</span>

<span class="sd">      Sometimes, a device gets confused about the state of its media.  Often,</span>
<span class="sd">      all it takes to solve the problem is to eject the media and then</span>
<span class="sd">      immediately reload it.  (There are also configurable eject and refresh</span>
<span class="sd">      media delays which can be applied, for situations where this makes a</span>
<span class="sd">      difference.)</span>

<span class="sd">      This only works if the device has a tray and supports ejecting its media.</span>
<span class="sd">      We have no way to know if the tray is currently open or closed, so we</span>
<span class="sd">      just send the appropriate command and hope for the best.  If the device</span>
<span class="sd">      does not have a tray or does not support ejecting its media, then we do</span>
<span class="sd">      nothing.  The configured delays still apply, though.</span>

<span class="sd">      Raises:</span>
<span class="sd">         IOError: If there is an error talking to the device</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">openTray</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">closeTray</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unlockTray</span><span class="p">()</span>  <span class="c1"># on some systems, writing a disc leaves the tray locked, yikes!</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">refreshMediaDelay</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Per configuration, sleeping </span><span class="si">%d</span><span class="s2"> seconds to stabilize media state.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refreshMediaDelay</span><span class="p">)</span>
         <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refreshMediaDelay</span><span class="p">)</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Media refresh complete; hopefully media state is stable now.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DvdWriter.writeImage"><a class="viewcode-back" href="../../../CedarBackup3.writers.html#CedarBackup3.writers.dvdwriter.DvdWriter.writeImage">[docs]</a>   <span class="k">def</span> <span class="nf">writeImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imagePath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">newDisc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">writeMulti</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Writes an ISO image to the media in the device.</span>

<span class="sd">      If ``newDisc`` is passed in as ``True``, we assume that the entire disc</span>
<span class="sd">      will be re-created from scratch.  Note that unlike ``CdWriter``,</span>
<span class="sd">      ``DvdWriter`` does not blank rewritable media before reusing it; however,</span>
<span class="sd">      ``growisofs`` is called such that the media will be re-initialized as</span>
<span class="sd">      needed.</span>

<span class="sd">      If ``imagePath`` is passed in as ``None``, then the existing image</span>
<span class="sd">      configured with ``initializeImage()`` will be used.  Under these</span>
<span class="sd">      circumstances, the passed-in ``newDisc`` flag will be ignored and the</span>
<span class="sd">      value passed in to ``initializeImage()`` will apply instead.</span>

<span class="sd">      The ``writeMulti`` argument is ignored.  It exists for compatibility with</span>
<span class="sd">      the Cedar Backup image writer interface.</span>

<span class="sd">      *Note:* The image size indicated in the log (&quot;Image size will be...&quot;) is</span>
<span class="sd">      an estimate.  The estimate is conservative and is probably larger than</span>
<span class="sd">      the actual space that ``dvdwriter`` will use.</span>

<span class="sd">      Args:</span>
<span class="sd">         imagePath (String representing a path on disk): Path to an ISO image on disk, or ``None`` to use writer&#39;s image</span>
<span class="sd">         newDisc (Boolean true/false): Indicates whether the disc should be re-initialized</span>
<span class="sd">         writeMulti (Boolean true/false): Unused</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If the image path is not absolute</span>
<span class="sd">         ValueError: If some path cannot be encoded properly</span>
<span class="sd">         IOError: If the media could not be written to for some reason</span>
<span class="sd">         ValueError: If no image is passed in and initializeImage() was not previously called</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">writeMulti</span><span class="p">:</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;writeMulti value of [</span><span class="si">%s</span><span class="s2">] ignored.&quot;</span><span class="p">,</span> <span class="n">writeMulti</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">imagePath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must call initializeImage() before using this method with no image path.&quot;</span><span class="p">)</span>
         <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEstimatedImageSize</span><span class="p">()</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Image size will be </span><span class="si">%s</span><span class="s2"> (estimated).&quot;</span><span class="p">,</span> <span class="n">displayBytes</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
         <span class="n">available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieveCapacity</span><span class="p">(</span><span class="n">entireDisc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">newDisc</span><span class="p">)</span><span class="o">.</span><span class="n">bytesAvailable</span>
         <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">available</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Image [</span><span class="si">%s</span><span class="s2">] does not fit in available capacity [</span><span class="si">%s</span><span class="s2">].&quot;</span><span class="p">,</span> <span class="n">displayBytes</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="n">displayBytes</span><span class="p">(</span><span class="n">available</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Media does not contain enough capacity to store image.&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_writeImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">newDisc</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">entries</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">mediaLabel</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">imagePath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Image path must be absolute.&quot;</span><span class="p">)</span>
         <span class="n">imagePath</span> <span class="o">=</span> <span class="n">encodePath</span><span class="p">(</span><span class="n">imagePath</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_writeImage</span><span class="p">(</span><span class="n">newDisc</span><span class="p">,</span> <span class="n">imagePath</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


   <span class="c1">##################################################################</span>
   <span class="c1"># Utility methods for dealing with growisofs and dvd+rw-mediainfo</span>
   <span class="c1">##################################################################</span>

   <span class="k">def</span> <span class="nf">_writeImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newDisc</span><span class="p">,</span> <span class="n">imagePath</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">mediaLabel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Writes an image to disc using either an entries list or an ISO image on</span>
<span class="sd">      disk.</span>

<span class="sd">      Callers are assumed to have done validation on paths, etc. before calling</span>
<span class="sd">      this method.</span>

<span class="sd">      Args:</span>
<span class="sd">         newDisc: Indicates whether the disc should be re-initialized</span>
<span class="sd">         imagePath: Path to an ISO image on disk, or c{None} to use ``entries``</span>
<span class="sd">         entries: Mapping from path to graft point, or ``None`` to use ``imagePath``</span>

<span class="sd">      Raises:</span>
<span class="sd">         IOError: If the media could not be written to for some reason</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">command</span> <span class="o">=</span> <span class="n">resolveCommand</span><span class="p">(</span><span class="n">GROWISOFS_COMMAND</span><span class="p">)</span>
      <span class="n">args</span> <span class="o">=</span> <span class="n">DvdWriter</span><span class="o">.</span><span class="n">_buildWriteArgs</span><span class="p">(</span><span class="n">newDisc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardwareId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_driveSpeed</span><span class="p">,</span> <span class="n">imagePath</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">mediaLabel</span><span class="p">,</span> <span class="n">dryRun</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
      <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="o">=</span> <span class="n">executeCommand</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">returnOutput</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">DvdWriter</span><span class="o">.</span><span class="n">_searchForOverburn</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="c1"># throws own exception if overburn condition is found</span>
         <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Error (</span><span class="si">%d</span><span class="s2">) executing command to write disc.&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">refreshMedia</span><span class="p">()</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_getEstimatedImageSize</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Gets the estimated size of a set of image entries.</span>

<span class="sd">      This is implemented in terms of the ``IsoImage`` class.  The returned</span>
<span class="sd">      value is calculated by adding a &quot;fudge factor&quot; to the value from</span>
<span class="sd">      ``IsoImage``.  This fudge factor was determined by experimentation and is</span>
<span class="sd">      conservative -- the actual image could be as much as 450 blocks smaller</span>
<span class="sd">      under some circumstances.</span>

<span class="sd">      Args:</span>
<span class="sd">         entries: Dictionary mapping path to graft point</span>

<span class="sd">      Returns:</span>
<span class="sd">          Total estimated size of image, in bytes</span>

<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If there are no entries in the dictionary</span>
<span class="sd">         ValueError: If any path in the dictionary does not exist</span>
<span class="sd">         IOError: If there is a problem calling ``mkisofs``</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">fudgeFactor</span> <span class="o">=</span> <span class="n">convertSize</span><span class="p">(</span><span class="mf">2500.0</span><span class="p">,</span> <span class="n">UNIT_SECTORS</span><span class="p">,</span> <span class="n">UNIT_BYTES</span><span class="p">)</span>  <span class="c1"># determined through experimentation</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">entries</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must add at least one entry with addImageEntry().&quot;</span><span class="p">)</span>
      <span class="n">image</span> <span class="o">=</span> <span class="n">IsoImage</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">entries</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
         <span class="n">image</span><span class="o">.</span><span class="n">addEntry</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">entries</span><span class="p">[</span><span class="n">path</span><span class="p">],</span> <span class="n">override</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">contentsOnly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">estimatedSize</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">getEstimatedSize</span><span class="p">()</span> <span class="o">+</span> <span class="n">fudgeFactor</span>
      <span class="k">return</span> <span class="n">estimatedSize</span>

   <span class="k">def</span> <span class="nf">_retrieveSectorsUsed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Retrieves the number of sectors used on the current media.</span>

<span class="sd">      This is a little ugly.  We need to call growisofs in &quot;dry-run&quot; mode and</span>
<span class="sd">      parse some information from its output.  However, to do that, we need to</span>
<span class="sd">      create a dummy file that we can pass to the command -- and we have to</span>
<span class="sd">      make sure to remove it later.</span>

<span class="sd">      Once growisofs has been run, then we call ``_parseSectorsUsed`` to parse</span>
<span class="sd">      the output and calculate the number of sectors used on the media.</span>

<span class="sd">      Returns:</span>
<span class="sd">          Number of sectors used on the media</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="n">entries</span> <span class="o">=</span> <span class="p">{</span> <span class="n">tempdir</span><span class="p">:</span> <span class="kc">None</span> <span class="p">}</span>
         <span class="n">args</span> <span class="o">=</span> <span class="n">DvdWriter</span><span class="o">.</span><span class="n">_buildWriteArgs</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hardwareId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">driveSpeed</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dryRun</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
         <span class="n">command</span> <span class="o">=</span> <span class="n">resolveCommand</span><span class="p">(</span><span class="n">GROWISOFS_COMMAND</span><span class="p">)</span>
         <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="o">=</span> <span class="n">executeCommand</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">returnOutput</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Error (</span><span class="si">%d</span><span class="s2">) calling growisofs to read sectors used.&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to read disc (might not be initialized); returning zero sectors used.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">0.0</span>
         <span class="n">sectorsUsed</span> <span class="o">=</span> <span class="n">DvdWriter</span><span class="o">.</span><span class="n">_parseSectorsUsed</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Determined sectors used as </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sectorsUsed</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">sectorsUsed</span>
      <span class="k">finally</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tempdir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
               <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_parseSectorsUsed</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Parse sectors used information out of ``growisofs`` output.</span>

<span class="sd">      The first line of a growisofs run looks something like this::</span>

<span class="sd">         Executing &#39;mkisofs -C 973744,1401056 -M /dev/fd/3 -r -graft-points music4/=music | builtin_dd of=/dev/cdrom obs=32k seek=87566&#39;</span>

<span class="sd">      Dmitry has determined that the seek value in this line gives us</span>
<span class="sd">      information about how much data has previously been written to the media.</span>
<span class="sd">      That value multiplied by 16 yields the number of sectors used.</span>

<span class="sd">      If the seek line cannot be found in the output, then sectors used of zero</span>
<span class="sd">      is assumed.</span>

<span class="sd">      Returns:</span>
<span class="sd">          Sectors used on the media, as a floating point number</span>

<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If the output cannot be parsed properly</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(^)(.*)(seek=)(.*)(&#39;$)&quot;</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
               <span class="k">try</span><span class="p">:</span>
                  <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">*</span> <span class="mf">16.0</span>
               <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                  <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to parse sectors used out of growisofs output.&quot;</span><span class="p">)</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to read disc (might not be initialized); returning zero sectors used.&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="mf">0.0</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_searchForOverburn</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Search for an &quot;overburn&quot; error message in ``growisofs`` output.</span>

<span class="sd">      The ``growisofs`` command returns a non-zero exit code and puts a message</span>
<span class="sd">      into the output -- even on a dry run -- if there is not enough space on</span>
<span class="sd">      the media.  This is called an &quot;overburn&quot; condition.</span>

<span class="sd">      The error message looks like this::</span>

<span class="sd">         :-( /dev/cdrom: 894048 blocks are free, 2033746 to be written!</span>

<span class="sd">      This method looks for the overburn error message anywhere in the output.</span>
<span class="sd">      If a matching error message is found, an ``IOError`` exception is raised</span>
<span class="sd">      containing relevant information about the problem.  Otherwise, the method</span>
<span class="sd">      call returns normally.</span>

<span class="sd">      Args:</span>
<span class="sd">         output: List of output lines to search, as from ``executeCommand``</span>

<span class="sd">      Raises:</span>
<span class="sd">         IOError: If an overburn condition is found</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">return</span>
      <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(^)(:-[(])(\s*.*:\s*)(.* )(blocks are free, )(.* )(to be written!)&quot;</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
         <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
               <span class="n">available</span> <span class="o">=</span> <span class="n">convertSize</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span> <span class="n">UNIT_SECTORS</span><span class="p">,</span> <span class="n">UNIT_BYTES</span><span class="p">)</span>
               <span class="n">size</span> <span class="o">=</span> <span class="n">convertSize</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span> <span class="n">UNIT_SECTORS</span><span class="p">,</span> <span class="n">UNIT_BYTES</span><span class="p">)</span>
               <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Image [</span><span class="si">%s</span><span class="s2">] does not fit in available capacity [</span><span class="si">%s</span><span class="s2">].&quot;</span><span class="p">,</span> <span class="n">displayBytes</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="n">displayBytes</span><span class="p">(</span><span class="n">available</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
               <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Image does not fit in available capacity (no useful capacity info available).&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Media does not contain enough capacity to store image.&quot;</span><span class="p">)</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">_buildWriteArgs</span><span class="p">(</span><span class="n">newDisc</span><span class="p">,</span> <span class="n">hardwareId</span><span class="p">,</span> <span class="n">driveSpeed</span><span class="p">,</span> <span class="n">imagePath</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">mediaLabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dryRun</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Builds a list of arguments to be passed to a ``growisofs`` command.</span>

<span class="sd">      The arguments will either cause ``growisofs`` to write the indicated image</span>
<span class="sd">      file to disc, or will pass ``growisofs`` a list of directories or files</span>
<span class="sd">      that should be written to disc.</span>

<span class="sd">      If a new image is created, it will always be created with Rock Ridge</span>
<span class="sd">      extensions (-r).  A volume name will be applied (-V) if ``mediaLabel`` is</span>
<span class="sd">      not ``None``.</span>

<span class="sd">      Args:</span>
<span class="sd">         newDisc: Indicates whether the disc should be re-initialized</span>
<span class="sd">         hardwareId: Hardware id for the device</span>
<span class="sd">         driveSpeed: Speed at which the drive writes</span>
<span class="sd">         imagePath: Path to an ISO image on disk, or c{None} to use ``entries``</span>
<span class="sd">         entries: Mapping from path to graft point, or ``None`` to use ``imagePath``</span>
<span class="sd">         mediaLabel: Media label to set on the image, if any</span>
<span class="sd">         dryRun: Says whether to make this a dry run (for checking capacity)</span>

<span class="sd">      *Note:* If we write an existing image to disc, then the mediaLabel is</span>
<span class="sd">      ignored.  The media label is an attribute of the image, and should be set</span>
<span class="sd">      on the image when it is created.</span>

<span class="sd">      *Note:* We always pass the undocumented option ``-use-the-force-like=tty``</span>
<span class="sd">      to growisofs.  Without this option, growisofs will refuse to execute</span>
<span class="sd">      certain actions when running from cron.  A good example is -Z, which</span>
<span class="sd">      happily overwrites an existing DVD from the command-line, but fails when</span>
<span class="sd">      run from cron.  It took a while to figure that out, since it worked every</span>
<span class="sd">      time I tested it by hand. :(</span>

<span class="sd">      Returns:</span>
<span class="sd">          List suitable for passing to :any:`util.executeCommand` as ``args``</span>

<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If caller does not pass one or the other of imagePath or entries</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">imagePath</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">entries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">imagePath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">entries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must use either imagePath or entries.&quot;</span><span class="p">)</span>
      <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-use-the-force-luke=tty&quot;</span><span class="p">)</span> <span class="c1"># tell growisofs to let us run from cron</span>
      <span class="k">if</span> <span class="n">dryRun</span><span class="p">:</span>
         <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-dry-run&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">driveSpeed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-speed=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">driveSpeed</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">newDisc</span><span class="p">:</span>
         <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-Z&quot;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-M&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">imagePath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hardwareId</span><span class="p">,</span> <span class="n">imagePath</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hardwareId</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">mediaLabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-V&quot;</span><span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mediaLabel</span><span class="p">)</span>
         <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-r&quot;</span><span class="p">)</span>    <span class="c1"># Rock Ridge extensions with sane ownership and permissions</span>
         <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-graft-points&quot;</span><span class="p">)</span>
         <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">entries</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
         <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> <span class="c1"># just so we get consistent results</span>
         <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="c1"># Same syntax as when calling mkisofs in IsoImage</span>
            <span class="k">if</span> <span class="n">entries</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
               <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">entries</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span> <span class="n">key</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">args</span></div>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Cedar Backup v3  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.9.
    </div>
  </body>
</html>
