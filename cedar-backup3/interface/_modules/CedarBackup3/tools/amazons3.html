<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>CedarBackup3.tools.amazons3 &#8212; Cedar Backup v3  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="top" title="Cedar Backup v3  documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Cedar Backup v3  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for CedarBackup3.tools.amazons3</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: iso-8859-1 -*-</span>
<span class="c1"># vim: set ft=python ts=3 sw=3 expandtab:</span>
<span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
<span class="c1">#</span>
<span class="c1">#              C E D A R</span>
<span class="c1">#          S O L U T I O N S       &quot;Software done right.&quot;</span>
<span class="c1">#           S O F T W A R E</span>
<span class="c1">#</span>
<span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2014-2016 Kenneth J. Pronovici.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This program is free software; you can redistribute it and/or</span>
<span class="c1"># modify it under the terms of the GNU General Public License,</span>
<span class="c1"># Version 2, as published by the Free Software Foundation.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="c1">#</span>
<span class="c1"># Copies of the GNU General Public License are available from</span>
<span class="c1"># the Free Software Foundation website, http://www.gnu.org/.</span>
<span class="c1">#</span>
<span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
<span class="c1">#</span>
<span class="c1"># Author   : Kenneth J. Pronovici &lt;pronovic@ieee.org&gt;</span>
<span class="c1"># Language : Python 3 (&gt;= 3.4)</span>
<span class="c1"># Project  : Cedar Backup, release 3</span>
<span class="c1"># Purpose  : Cedar Backup tool to synchronize an Amazon S3 bucket.</span>
<span class="c1">#</span>
<span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

<span class="c1">########################################################################</span>
<span class="c1"># Notes</span>
<span class="c1">########################################################################</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Synchonizes a local directory with an Amazon S3 bucket.</span>

<span class="sd">No configuration is required; all necessary information is taken from the</span>
<span class="sd">command-line.  The only thing configuration would help with is the path</span>
<span class="sd">resolver interface, and it doesn&#39;t seem worth it to require configuration just</span>
<span class="sd">to get that.</span>

<span class="sd">:author: Kenneth J. Pronovici &lt;pronovic@ieee.org&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">########################################################################</span>
<span class="c1"># Imported modules and constants</span>
<span class="c1">########################################################################</span>

<span class="c1"># System modules</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">getopt</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">total_ordering</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">chardet</span>

<span class="c1"># Cedar Backup modules</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.release</span> <span class="k">import</span> <span class="n">AUTHOR</span><span class="p">,</span> <span class="n">EMAIL</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span> <span class="n">DATE</span><span class="p">,</span> <span class="n">COPYRIGHT</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.filesystem</span> <span class="k">import</span> <span class="n">FilesystemList</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.cli</span> <span class="k">import</span> <span class="n">setupLogging</span><span class="p">,</span> <span class="n">DEFAULT_LOGFILE</span><span class="p">,</span> <span class="n">DEFAULT_OWNERSHIP</span><span class="p">,</span> <span class="n">DEFAULT_MODE</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.util</span> <span class="k">import</span> <span class="n">Diagnostics</span><span class="p">,</span> <span class="n">splitCommandLine</span><span class="p">,</span> <span class="n">encodePath</span>
<span class="kn">from</span> <span class="nn">CedarBackup3.util</span> <span class="k">import</span> <span class="n">executeCommand</span>


<span class="c1">########################################################################</span>
<span class="c1"># Module-wide constants and variables</span>
<span class="c1">########################################################################</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;CedarBackup3.log.tools.amazons3&quot;</span><span class="p">)</span>

<span class="n">AWS_COMMAND</span>   <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;aws&quot;</span> <span class="p">]</span>

<span class="n">SHORT_SWITCHES</span>     <span class="o">=</span> <span class="s2">&quot;hVbql:o:m:OdsDvw&quot;</span>
<span class="n">LONG_SWITCHES</span>      <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;help&#39;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="s1">&#39;quiet&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;logfile=&#39;</span><span class="p">,</span> <span class="s1">&#39;owner=&#39;</span><span class="p">,</span> <span class="s1">&#39;mode=&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">,</span> <span class="s1">&#39;diagnostics&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;verifyOnly&#39;</span><span class="p">,</span> <span class="s1">&#39;ignoreWarnings&#39;</span><span class="p">,</span> <span class="p">]</span>


<span class="c1">#######################################################################</span>
<span class="c1"># Options class</span>
<span class="c1">#######################################################################</span>

<span class="nd">@total_ordering</span>
<div class="viewcode-block" id="Options"><a class="viewcode-back" href="../../../CedarBackup3.tools.html#CedarBackup3.tools.amazons3.Options">[docs]</a><span class="k">class</span> <span class="nc">Options</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

   <span class="c1">######################</span>
   <span class="c1"># Class documentation</span>
   <span class="c1">######################</span>

   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Class representing command-line options for the cback3-amazons3-sync script.</span>

<span class="sd">   The ``Options`` class is a Python object representation of the command-line</span>
<span class="sd">   options of the cback3-amazons3-sync script.</span>

<span class="sd">   The object representation is two-way: a command line string or a list of</span>
<span class="sd">   command line arguments can be used to create an ``Options`` object, and then</span>
<span class="sd">   changes to the object can be propogated back to a list of command-line</span>
<span class="sd">   arguments or to a command-line string.  An ``Options`` object can even be</span>
<span class="sd">   created from scratch programmatically (if you have a need for that).</span>

<span class="sd">   There are two main levels of validation in the ``Options`` class.  The first</span>
<span class="sd">   is field-level validation.  Field-level validation comes into play when a</span>
<span class="sd">   given field in an object is assigned to or updated.  We use Python&#39;s</span>
<span class="sd">   ``property`` functionality to enforce specific validations on field values,</span>
<span class="sd">   and in some places we even use customized list classes to enforce</span>
<span class="sd">   validations on list members.  You should expect to catch a ``ValueError``</span>
<span class="sd">   exception when making assignments to fields if you are programmatically</span>
<span class="sd">   filling an object.</span>

<span class="sd">   The second level of validation is post-completion validation.  Certain</span>
<span class="sd">   validations don&#39;t make sense until an object representation of options is</span>
<span class="sd">   fully &quot;complete&quot;.  We don&#39;t want these validations to apply all of the time,</span>
<span class="sd">   because it would make building up a valid object from scratch a real pain.</span>
<span class="sd">   For instance, we might have to do things in the right order to keep from</span>
<span class="sd">   throwing exceptions, etc.</span>

<span class="sd">   All of these post-completion validations are encapsulated in the</span>
<span class="sd">   :any:`Options.validate` method.  This method can be called at any time by a</span>
<span class="sd">   client, and will always be called immediately after creating a ``Options``</span>
<span class="sd">   object from a command line and before exporting a ``Options`` object back to</span>
<span class="sd">   a command line.  This way, we get acceptable ease-of-use but we also don&#39;t</span>
<span class="sd">   accept or emit invalid command lines.</span>

<span class="sd">   *Note:* Lists within this class are &quot;unordered&quot; for equality comparisons.</span>

<span class="sd">   &quot;&quot;&quot;</span>

   <span class="c1">##############</span>
   <span class="c1"># Constructor</span>
   <span class="c1">##############</span>

<div class="viewcode-block" id="Options.__init__"><a class="viewcode-back" href="../../../CedarBackup3.tools.html#CedarBackup3.tools.amazons3.Options.__init__">[docs]</a>   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argumentList</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">argumentString</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Initializes an options object.</span>

<span class="sd">      If you initialize the object without passing either ``argumentList`` or</span>
<span class="sd">      ``argumentString``, the object will be empty and will be invalid until it</span>
<span class="sd">      is filled in properly.</span>

<span class="sd">      No reference to the original arguments is saved off by this class.  Once</span>
<span class="sd">      the data has been parsed (successfully or not) this original information</span>
<span class="sd">      is discarded.</span>

<span class="sd">      The argument list is assumed to be a list of arguments, not including the</span>
<span class="sd">      name of the command, something like ``sys.argv[1:]``.  If you pass</span>
<span class="sd">      ``sys.argv`` instead, things are not going to work.</span>

<span class="sd">      The argument string will be parsed into an argument list by the</span>
<span class="sd">      :any:`util.splitCommandLine` function (see the documentation for that</span>
<span class="sd">      function for some important notes about its limitations).  There is an</span>
<span class="sd">      assumption that the resulting list will be equivalent to ``sys.argv[1:]``,</span>
<span class="sd">      just like ``argumentList``.</span>

<span class="sd">      Unless the ``validate`` argument is ``False``, the :any:`Options.validate`</span>
<span class="sd">      method will be called (with its default arguments) after successfully</span>
<span class="sd">      parsing any passed-in command line.  This validation ensures that</span>
<span class="sd">      appropriate actions, etc. have been specified.  Keep in mind that even if</span>
<span class="sd">      ``validate`` is ``False``, it might not be possible to parse the passed-in</span>
<span class="sd">      command line, so an exception might still be raised.</span>

<span class="sd">      *Note:* The command line format is specified by the ``_usage`` function.</span>
<span class="sd">      Call ``_usage`` to see a usage statement for the cback3-amazons3-sync script.</span>

<span class="sd">      *Note:* It is strongly suggested that the ``validate`` option always be set</span>
<span class="sd">      to ``True`` (the default) unless there is a specific need to read in</span>
<span class="sd">      invalid command line arguments.</span>

<span class="sd">      Args:</span>
<span class="sd">         argumentList (List of arguments, i.e. ``sys.argv``): Command line for a program</span>
<span class="sd">         argumentString (String, i.e. &quot;cback3-amazons3-sync --verbose stage store&quot;): Command line for a program</span>
<span class="sd">         validate (Boolean true/false): Validate the command line after parsing it</span>
<span class="sd">      Raises:</span>
<span class="sd">         getopt.GetoptError: If the command-line arguments could not be parsed</span>
<span class="sd">         ValueError: If the command-line arguments are invalid</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_help</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_logfile</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_stacktrace</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_verifyOnly</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_ignoreWarnings</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_sourceDir</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_s3BucketUrl</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">if</span> <span class="n">argumentList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">argumentString</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Use either argumentList or argumentString, but not both.&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">argumentString</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentList</span> <span class="o">=</span> <span class="n">splitCommandLine</span><span class="p">(</span><span class="n">argumentString</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">argumentList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_parseArgumentList</span><span class="p">(</span><span class="n">argumentList</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span></div>


   <span class="c1">#########################</span>
   <span class="c1"># String representations</span>
   <span class="c1">#########################</span>

   <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Official string representation for class instance.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildArgumentString</span><span class="p">(</span><span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Informal string representation for class instance.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>


   <span class="c1">#############################</span>
   <span class="c1"># Standard comparison method</span>
   <span class="c1">#############################</span>

   <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Equals operator, iplemented in terms of original Python 2 compare operator.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

   <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Less-than operator, iplemented in terms of original Python 2 compare operator.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>

   <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Greater-than operator, iplemented in terms of original Python 2 compare operator.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

   <span class="k">def</span> <span class="nf">__cmp__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Original Python 2 comparison operator.</span>
<span class="sd">      Lists within this class are &quot;unordered&quot; for equality comparisons.</span>
<span class="sd">      Args:</span>
<span class="sd">         other: Other object to compare to</span>
<span class="sd">      Returns:</span>
<span class="sd">          -1/0/1 depending on whether self is ``&lt;``, ``=`` or ``&gt;`` other</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">logfile</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">owner</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">owner</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">mode</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacktrace</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">stacktrace</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacktrace</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">stacktrace</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verifyOnly</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">verifyOnly</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verifyOnly</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">verifyOnly</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignoreWarnings</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">ignoreWarnings</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignoreWarnings</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">ignoreWarnings</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourceDir</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">sourceDir</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sourceDir</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">sourceDir</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3BucketUrl</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">s3BucketUrl</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s3BucketUrl</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">s3BucketUrl</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
      <span class="k">return</span> <span class="mi">0</span>


   <span class="c1">#############</span>
   <span class="c1"># Properties</span>
   <span class="c1">#############</span>

   <span class="k">def</span> <span class="nf">_setHelp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the help flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_help</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_help</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getHelp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the help flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_help</span>

   <span class="k">def</span> <span class="nf">_setVersion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the version flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getVersion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the version flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span>

   <span class="k">def</span> <span class="nf">_setVerbose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the verbose flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getVerbose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the verbose flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span>

   <span class="k">def</span> <span class="nf">_setQuiet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the quiet flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getQuiet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the quiet flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span>

   <span class="k">def</span> <span class="nf">_setLogfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the logfile parameter.</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If the value cannot be encoded properly</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The logfile parameter must be a non-empty string.&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_logfile</span> <span class="o">=</span> <span class="n">encodePath</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">_getLogfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the logfile parameter.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logfile</span>

   <span class="k">def</span> <span class="nf">_setOwner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the owner parameter.</span>
<span class="sd">      If not ``None``, the owner must be a ``(user,group)`` tuple or list.</span>
<span class="sd">      Strings (and inherited children of strings) are explicitly disallowed.</span>
<span class="sd">      The value will be normalized to a tuple.</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If the value is not valid</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must specify user and group tuple for owner parameter.&quot;</span><span class="p">)</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must specify user and group tuple for owner parameter.&quot;</span><span class="p">)</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;User and group tuple values must be non-empty strings.&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

   <span class="k">def</span> <span class="nf">_getOwner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the owner parameter.</span>
<span class="sd">      The parameter is a tuple of ``(user, group)``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span>

   <span class="k">def</span> <span class="nf">_setMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the mode parameter.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
               <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
         <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mode must be an octal integer &gt;= 0, i.e. 644.&quot;</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mode must be an octal integer &gt;= 0. i.e. 644.&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">value</span>

   <span class="k">def</span> <span class="nf">_getMode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the mode parameter.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span>

   <span class="k">def</span> <span class="nf">_setOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the output flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the output flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span>

   <span class="k">def</span> <span class="nf">_setDebug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the debug flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getDebug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the debug flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span>

   <span class="k">def</span> <span class="nf">_setStacktrace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the stacktrace flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_stacktrace</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_stacktrace</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getStacktrace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the stacktrace flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stacktrace</span>

   <span class="k">def</span> <span class="nf">_setDiagnostics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the diagnostics flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getDiagnostics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the diagnostics flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics</span>

   <span class="k">def</span> <span class="nf">_setVerifyOnly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the verifyOnly flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_verifyOnly</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_verifyOnly</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getVerifyOnly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the verifyOnly flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verifyOnly</span>

   <span class="k">def</span> <span class="nf">_setIgnoreWarnings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the ignoreWarnings flag.</span>
<span class="sd">      No validations, but we normalize the value to ``True`` or ``False``.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_ignoreWarnings</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_ignoreWarnings</span> <span class="o">=</span> <span class="kc">False</span>

   <span class="k">def</span> <span class="nf">_getIgnoreWarnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the ignoreWarnings flag.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignoreWarnings</span>

   <span class="k">def</span> <span class="nf">_setSourceDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the sourceDir parameter.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The sourceDir parameter must be a non-empty string.&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_sourceDir</span> <span class="o">=</span> <span class="n">value</span>

   <span class="k">def</span> <span class="nf">_getSourceDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the sourceDir parameter.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sourceDir</span>

   <span class="k">def</span> <span class="nf">_setS3BucketUrl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to set the s3BucketUrl parameter.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The s3BucketUrl parameter must be a non-empty string.&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_s3BucketUrl</span> <span class="o">=</span> <span class="n">value</span>

   <span class="k">def</span> <span class="nf">_getS3BucketUrl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Property target used to get the s3BucketUrl parameter.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_s3BucketUrl</span>

   <span class="n">help</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getHelp</span><span class="p">,</span> <span class="n">_setHelp</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line help (``-h,--help``) flag.&quot;</span><span class="p">)</span>
   <span class="n">version</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getVersion</span><span class="p">,</span> <span class="n">_setVersion</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line version (``-V,--version``) flag.&quot;</span><span class="p">)</span>
   <span class="n">verbose</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getVerbose</span><span class="p">,</span> <span class="n">_setVerbose</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line verbose (``-b,--verbose``) flag.&quot;</span><span class="p">)</span>
   <span class="n">quiet</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getQuiet</span><span class="p">,</span> <span class="n">_setQuiet</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line quiet (``-q,--quiet``) flag.&quot;</span><span class="p">)</span>
   <span class="n">logfile</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getLogfile</span><span class="p">,</span> <span class="n">_setLogfile</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line logfile (``-l,--logfile``) parameter.&quot;</span><span class="p">)</span>
   <span class="n">owner</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getOwner</span><span class="p">,</span> <span class="n">_setOwner</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line owner (``-o,--owner``) parameter, as tuple ``(user,group)``.&quot;</span><span class="p">)</span>
   <span class="n">mode</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getMode</span><span class="p">,</span> <span class="n">_setMode</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line mode (``-m,--mode``) parameter.&quot;</span><span class="p">)</span>
   <span class="n">output</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getOutput</span><span class="p">,</span> <span class="n">_setOutput</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line output (``-O,--output``) flag.&quot;</span><span class="p">)</span>
   <span class="n">debug</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getDebug</span><span class="p">,</span> <span class="n">_setDebug</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line debug (``-d,--debug``) flag.&quot;</span><span class="p">)</span>
   <span class="n">stacktrace</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getStacktrace</span><span class="p">,</span> <span class="n">_setStacktrace</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line stacktrace (``-s,--stack``) flag.&quot;</span><span class="p">)</span>
   <span class="n">diagnostics</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getDiagnostics</span><span class="p">,</span> <span class="n">_setDiagnostics</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line diagnostics (``-D,--diagnostics``) flag.&quot;</span><span class="p">)</span>
   <span class="n">verifyOnly</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getVerifyOnly</span><span class="p">,</span> <span class="n">_setVerifyOnly</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line verifyOnly (``-v,--verifyOnly``) flag.&quot;</span><span class="p">)</span>
   <span class="n">ignoreWarnings</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getIgnoreWarnings</span><span class="p">,</span> <span class="n">_setIgnoreWarnings</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line ignoreWarnings (``-w,--ignoreWarnings``) flag&quot;</span><span class="p">)</span>
   <span class="n">sourceDir</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getSourceDir</span><span class="p">,</span> <span class="n">_setSourceDir</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line sourceDir, source of sync.&quot;</span><span class="p">)</span>
   <span class="n">s3BucketUrl</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_getS3BucketUrl</span><span class="p">,</span> <span class="n">_setS3BucketUrl</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Command-line s3BucketUrl, target of sync.&quot;</span><span class="p">)</span>


   <span class="c1">##################</span>
   <span class="c1"># Utility methods</span>
   <span class="c1">##################</span>

<div class="viewcode-block" id="Options.validate"><a class="viewcode-back" href="../../../CedarBackup3.tools.html#CedarBackup3.tools.amazons3.Options.validate">[docs]</a>   <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Validates command-line options represented by the object.</span>

<span class="sd">      Unless ``--help`` or ``--version`` are supplied, at least one action must</span>
<span class="sd">      be specified.  Other validations (as for allowed values for particular</span>
<span class="sd">      options) will be taken care of at assignment time by the properties</span>
<span class="sd">      functionality.</span>

<span class="sd">      *Note:* The command line format is specified by the ``_usage`` function.</span>
<span class="sd">      Call ``_usage`` to see a usage statement for the cback3-amazons3-sync script.</span>

<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If one of the validations fails</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourceDir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3BucketUrl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Source directory and S3 bucket URL are both required.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Options.buildArgumentList"><a class="viewcode-back" href="../../../CedarBackup3.tools.html#CedarBackup3.tools.amazons3.Options.buildArgumentList">[docs]</a>   <span class="k">def</span> <span class="nf">buildArgumentList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Extracts options into a list of command line arguments.</span>

<span class="sd">      The original order of the various arguments (if, indeed, the object was</span>
<span class="sd">      initialized with a command-line) is not preserved in this generated</span>
<span class="sd">      argument list.   Besides that, the argument list is normalized to use the</span>
<span class="sd">      long option names (i.e. --version rather than -V).  The resulting list</span>
<span class="sd">      will be suitable for passing back to the constructor in the</span>
<span class="sd">      ``argumentList`` parameter.  Unlike :any:`buildArgumentString`, string</span>
<span class="sd">      arguments are not quoted here, because there is no need for it.</span>

<span class="sd">      Unless the ``validate`` parameter is ``False``, the :any:`Options.validate`</span>
<span class="sd">      method will be called (with its default arguments) against the</span>
<span class="sd">      options before extracting the command line.  If the options are not valid,</span>
<span class="sd">      then an argument list will not be extracted.</span>

<span class="sd">      *Note:* It is strongly suggested that the ``validate`` option always be set</span>
<span class="sd">      to ``True`` (the default) unless there is a specific need to extract an</span>
<span class="sd">      invalid command line.</span>

<span class="sd">      Args:</span>
<span class="sd">         validate (Boolean true/false): Validate the options before extracting the command line</span>
<span class="sd">      Returns:</span>
<span class="sd">          List representation of command-line arguments</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If options within the object are invalid</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
      <span class="n">argumentList</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_help</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--help&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--version&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--verbose&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--quiet&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--logfile&quot;</span><span class="p">)</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--owner&quot;</span><span class="p">)</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--mode&quot;</span><span class="p">)</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%o</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--output&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--debug&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacktrace</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--stack&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--diagnostics&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verifyOnly</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--verifyOnly&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignoreWarnings</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--ignoreWarnings&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourceDir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sourceDir</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3BucketUrl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s3BucketUrl</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">argumentList</span></div>

<div class="viewcode-block" id="Options.buildArgumentString"><a class="viewcode-back" href="../../../CedarBackup3.tools.html#CedarBackup3.tools.amazons3.Options.buildArgumentString">[docs]</a>   <span class="k">def</span> <span class="nf">buildArgumentString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Extracts options into a string of command-line arguments.</span>

<span class="sd">      The original order of the various arguments (if, indeed, the object was</span>
<span class="sd">      initialized with a command-line) is not preserved in this generated</span>
<span class="sd">      argument string.   Besides that, the argument string is normalized to use</span>
<span class="sd">      the long option names (i.e. --version rather than -V) and to quote all</span>
<span class="sd">      string arguments with double quotes (``&quot;``).  The resulting string will be</span>
<span class="sd">      suitable for passing back to the constructor in the ``argumentString``</span>
<span class="sd">      parameter.</span>

<span class="sd">      Unless the ``validate`` parameter is ``False``, the :any:`Options.validate`</span>
<span class="sd">      method will be called (with its default arguments) against the options</span>
<span class="sd">      before extracting the command line.  If the options are not valid, then</span>
<span class="sd">      an argument string will not be extracted.</span>

<span class="sd">      *Note:* It is strongly suggested that the ``validate`` option always be set</span>
<span class="sd">      to ``True`` (the default) unless there is a specific need to extract an</span>
<span class="sd">      invalid command line.</span>

<span class="sd">      Args:</span>
<span class="sd">         validate (Boolean true/false): Validate the options before extracting the command line</span>
<span class="sd">      Returns:</span>
<span class="sd">          String representation of command-line arguments</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If options within the object are invalid</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
      <span class="n">argumentString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_help</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--help &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--version &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--verbose &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--quiet &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--logfile </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--owner </span><span class="se">\&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--mode </span><span class="si">%o</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--output &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--debug &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacktrace</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--stack &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--diagnostics &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verifyOnly</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--verifyOnly &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignoreWarnings</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span> <span class="s2">&quot;--ignoreWarnings &quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourceDir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span>  <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourceDir</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3BucketUrl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">argumentString</span> <span class="o">+=</span>  <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3BucketUrl</span>
      <span class="k">return</span> <span class="n">argumentString</span></div>

   <span class="k">def</span> <span class="nf">_parseArgumentList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argumentList</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Internal method to parse a list of command-line arguments.</span>

<span class="sd">      Most of the validation we do here has to do with whether the arguments</span>
<span class="sd">      can be parsed and whether any values which exist are valid.  We don&#39;t do</span>
<span class="sd">      any validation as to whether required elements exist or whether elements</span>
<span class="sd">      exist in the proper combination (instead, that&#39;s the job of the</span>
<span class="sd">      :any:`validate` method).</span>

<span class="sd">      For any of the options which supply parameters, if the option is</span>
<span class="sd">      duplicated with long and short switches (i.e. ``-l`` and a ``--logfile``)</span>
<span class="sd">      then the long switch is used.  If the same option is duplicated with the</span>
<span class="sd">      same switch (long or short), then the last entry on the command line is</span>
<span class="sd">      used.</span>

<span class="sd">      Args:</span>
<span class="sd">         argumentList (List of arguments to a command, i.e. ``sys.argv[1:]``): List of arguments to a command</span>
<span class="sd">      Raises:</span>
<span class="sd">         ValueError: If the argument list cannot be successfully parsed</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">switches</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>
      <span class="n">opts</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">getopt</span><span class="o">.</span><span class="n">getopt</span><span class="p">(</span><span class="n">argumentList</span><span class="p">,</span> <span class="n">SHORT_SWITCHES</span><span class="p">,</span> <span class="n">LONG_SWITCHES</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>  <span class="c1"># push the switches into a hash</span>
         <span class="n">switches</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
      <span class="k">if</span> <span class="s2">&quot;-h&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--help&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">help</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-V&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--version&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-b&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--verbose&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-q&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--quiet&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-l&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="n">switches</span><span class="p">[</span><span class="s2">&quot;-l&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s2">&quot;--logfile&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="n">switches</span><span class="p">[</span><span class="s2">&quot;--logfile&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s2">&quot;-o&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">switches</span><span class="p">[</span><span class="s2">&quot;-o&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">if</span> <span class="s2">&quot;--owner&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">switches</span><span class="p">[</span><span class="s2">&quot;--owner&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">if</span> <span class="s2">&quot;-m&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">switches</span><span class="p">[</span><span class="s2">&quot;-m&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s2">&quot;--mode&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">switches</span><span class="p">[</span><span class="s2">&quot;--mode&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s2">&quot;-O&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--output&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-d&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--debug&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-s&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--stack&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">stacktrace</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-D&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--diagnostics&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-v&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--verifyOnly&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">verifyOnly</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="s2">&quot;-w&quot;</span> <span class="ow">in</span> <span class="n">switches</span> <span class="ow">or</span> <span class="s2">&quot;--ignoreWarnings&quot;</span> <span class="ow">in</span> <span class="n">switches</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">ignoreWarnings</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sourceDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3BucketUrl</span><span class="p">)</span> <span class="o">=</span> <span class="n">remaining</span>
      <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
         <span class="k">pass</span></div>


<span class="c1">#######################################################################</span>
<span class="c1"># Public functions</span>
<span class="c1">#######################################################################</span>

<span class="c1">#################</span>
<span class="c1"># cli() function</span>
<span class="c1">#################</span>

<div class="viewcode-block" id="cli"><a class="viewcode-back" href="../../../CedarBackup3.tools.html#CedarBackup3.tools.amazons3.cli">[docs]</a><span class="k">def</span> <span class="nf">cli</span><span class="p">():</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Implements the command-line interface for the ``cback3-amazons3-sync`` script.</span>

<span class="sd">   Essentially, this is the &quot;main routine&quot; for the cback3-amazons3-sync script.  It does</span>
<span class="sd">   all of the argument processing for the script, and then also implements the</span>
<span class="sd">   tool functionality.</span>

<span class="sd">   This function looks pretty similiar to ``CedarBackup3.cli.cli()``.  It&#39;s not</span>
<span class="sd">   easy to refactor this code to make it reusable and also readable, so I&#39;ve</span>
<span class="sd">   decided to just live with the duplication.</span>

<span class="sd">   A different error code is returned for each type of failure:</span>

<span class="sd">      - ``1``: The Python interpreter version is &lt; 3.4</span>
<span class="sd">      - ``2``: Error processing command-line arguments</span>
<span class="sd">      - ``3``: Error configuring logging</span>
<span class="sd">      - ``5``: Backup was interrupted with a CTRL-C or similar</span>
<span class="sd">      - ``6``: Error executing other parts of the script</span>

<span class="sd">   *Note:* This script uses print rather than logging to the INFO level, because</span>
<span class="sd">   it is interactive.  Underlying Cedar Backup functionality uses the logging</span>
<span class="sd">   mechanism exclusively.</span>

<span class="sd">   Returns:</span>
<span class="sd">       Error code as described above</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span> <span class="o">&lt;</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
         <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Python 3 version 3.4 or greater required.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
         <span class="k">return</span> <span class="mi">1</span>
   <span class="k">except</span><span class="p">:</span>
      <span class="c1"># sys.version_info isn&#39;t available before 2.0</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Python 3 version 3.4 or greater required.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="mi">1</span>

   <span class="k">try</span><span class="p">:</span>
      <span class="n">options</span> <span class="o">=</span> <span class="n">Options</span><span class="p">(</span><span class="n">argumentList</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
   <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">_usage</span><span class="p">()</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; *** Error: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
      <span class="k">return</span> <span class="mi">2</span>

   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
      <span class="n">_usage</span><span class="p">()</span>
      <span class="k">return</span> <span class="mi">0</span>
   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
      <span class="n">_version</span><span class="p">()</span>
      <span class="k">return</span> <span class="mi">0</span>
   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
      <span class="n">_diagnostics</span><span class="p">()</span>
      <span class="k">return</span> <span class="mi">0</span>

   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">stacktrace</span><span class="p">:</span>
      <span class="n">logfile</span> <span class="o">=</span> <span class="n">setupLogging</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="n">logfile</span> <span class="o">=</span> <span class="n">setupLogging</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Error setting up logging: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
         <span class="k">return</span> <span class="mi">3</span>

   <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cedar Backup Amazon S3 sync run started.&quot;</span><span class="p">)</span>
   <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Options were [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
   <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Logfile is [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">logfile</span><span class="p">)</span>
   <span class="n">Diagnostics</span><span class="p">()</span><span class="o">.</span><span class="n">logDiagnostics</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>

   <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">stacktrace</span><span class="p">:</span>
      <span class="n">_executeAction</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="n">_executeAction</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Backup interrupted.&quot;</span><span class="p">)</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cedar Backup Amazon S3 sync run completed with status 5.&quot;</span><span class="p">)</span>
         <span class="k">return</span> <span class="mi">5</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error executing backup: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cedar Backup Amazon S3 sync run completed with status 6.&quot;</span><span class="p">)</span>
         <span class="k">return</span> <span class="mi">6</span>

   <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cedar Backup Amazon S3 sync run completed with status 0.&quot;</span><span class="p">)</span>
   <span class="k">return</span> <span class="mi">0</span></div>


<span class="c1">#######################################################################</span>
<span class="c1"># Utility functions</span>
<span class="c1">#######################################################################</span>

<span class="c1">####################</span>
<span class="c1"># _usage() function</span>
<span class="c1">####################</span>

<span class="k">def</span> <span class="nf">_usage</span><span class="p">(</span><span class="n">fd</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Prints usage information for the cback3-amazons3-sync script.</span>
<span class="sd">   Args:</span>
<span class="sd">      fd: File descriptor used to print information</span>
<span class="sd">   *Note:* The ``fd`` is used rather than ``print`` to facilitate unit testing.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Usage: cback3-amazons3-sync [switches] sourceDir s3bucketUrl</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Cedar Backup Amazon S3 sync tool.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; This Cedar Backup utility synchronizes a local directory to an Amazon S3</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; bucket.  After the sync is complete, a validation step is taken.  An</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; error is reported if the contents of the bucket do not match the</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; source directory, or if the indicated size for any file differs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; This tool is a wrapper over the AWS CLI command-line tool.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; The following arguments are required:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   sourceDir            The local source directory on disk (must exist)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   s3BucketUrl          The URL to the target Amazon S3 bucket</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; The following switches are accepted:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -h, --help           Display this usage/help listing</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -V, --version        Display version information</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -b, --verbose        Print verbose output as well as logging to disk</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -q, --quiet          Run quietly (display no output to the screen)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -l, --logfile        Path to logfile (default: </span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">DEFAULT_LOGFILE</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -o, --owner          Logfile ownership, user:group (default: </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DEFAULT_OWNERSHIP</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">DEFAULT_OWNERSHIP</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -m, --mode           Octal logfile permissions mode (default: </span><span class="si">%o</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">DEFAULT_MODE</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -O, --output         Record some sub-command (i.e. aws) output to the log</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -d, --debug          Write debugging information to the log (implies --output)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -s, --stack          Dump Python stack trace instead of swallowing exceptions</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># exactly 80 characters in width!</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -D, --diagnostics    Print runtime diagnostics to the screen and exit</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -v, --verifyOnly     Only verify the S3 bucket contents, do not make changes</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   -w, --ignoreWarnings Ignore warnings about problematic filename encodings</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Typical usage would be something like:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   cback3-amazons3-sync /home/myuser s3://example.com-backup/myuser</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; This will sync the contents of /home/myuser into the indicated bucket.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1">######################</span>
<span class="c1"># _version() function</span>
<span class="c1">######################</span>

<span class="k">def</span> <span class="nf">_version</span><span class="p">(</span><span class="n">fd</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Prints version information for the cback3-amazons3-sync script.</span>
<span class="sd">   Args:</span>
<span class="sd">      fd: File descriptor used to print information</span>
<span class="sd">   *Note:* The ``fd`` is used rather than ``print`` to facilitate unit testing.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Cedar Backup Amazon S3 sync tool.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Included with Cedar Backup version </span><span class="si">%s</span><span class="s2">, released </span><span class="si">%s</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">VERSION</span><span class="p">,</span> <span class="n">DATE</span><span class="p">))</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Copyright (c) </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> &lt;</span><span class="si">%s</span><span class="s2">&gt;.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">COPYRIGHT</span><span class="p">,</span> <span class="n">AUTHOR</span><span class="p">,</span> <span class="n">EMAIL</span><span class="p">))</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; See CREDITS for a list of included code and other contributors.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; This is free software; there is NO warranty.  See the</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; GNU General Public License version 2 for copying conditions.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Use the --help option for usage information.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1">##########################</span>
<span class="c1"># _diagnostics() function</span>
<span class="c1">##########################</span>

<span class="k">def</span> <span class="nf">_diagnostics</span><span class="p">(</span><span class="n">fd</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Prints runtime diagnostics information.</span>
<span class="sd">   Args:</span>
<span class="sd">      fd: File descriptor used to print information</span>
<span class="sd">   *Note:* The ``fd`` is used rather than ``print`` to facilitate unit testing.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Diagnostics:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
   <span class="n">Diagnostics</span><span class="p">()</span><span class="o">.</span><span class="n">printDiagnostics</span><span class="p">(</span><span class="n">fd</span><span class="o">=</span><span class="n">fd</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;   &quot;</span><span class="p">)</span>
   <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1">############################</span>
<span class="c1"># _executeAction() function</span>
<span class="c1">############################</span>

<span class="k">def</span> <span class="nf">_executeAction</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Implements the guts of the cback3-amazons3-sync tool.</span>

<span class="sd">   Args:</span>
<span class="sd">      options (Options object): Program command-line options</span>
<span class="sd">   Raises:</span>
<span class="sd">      Exception: Under many generic error conditions</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">sourceFiles</span> <span class="o">=</span> <span class="n">_buildSourceFiles</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">sourceDir</span><span class="p">)</span>
   <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">ignoreWarnings</span><span class="p">:</span>
      <span class="n">_checkSourceFiles</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">sourceDir</span><span class="p">,</span> <span class="n">sourceFiles</span><span class="p">)</span>
   <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">verifyOnly</span><span class="p">:</span>
      <span class="n">_synchronizeBucket</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">sourceDir</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">s3BucketUrl</span><span class="p">)</span>
   <span class="n">_verifyBucketContents</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">sourceDir</span><span class="p">,</span> <span class="n">sourceFiles</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">s3BucketUrl</span><span class="p">)</span>


<span class="c1">################################</span>
<span class="c1"># _buildSourceFiles() function</span>
<span class="c1">################################</span>

<span class="k">def</span> <span class="nf">_buildSourceFiles</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Build a list of files in a source directory</span>
<span class="sd">   Args:</span>
<span class="sd">      sourceDir: Local source directory</span>
<span class="sd">   Returns:</span>
<span class="sd">       FilesystemList with contents of source directory</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Source directory does not exist on disk.&quot;</span><span class="p">)</span>
   <span class="n">sourceFiles</span> <span class="o">=</span> <span class="n">FilesystemList</span><span class="p">()</span>
   <span class="n">sourceFiles</span><span class="o">.</span><span class="n">addDirContents</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">sourceFiles</span>


<span class="c1">###############################</span>
<span class="c1"># _checkSourceFiles() function</span>
<span class="c1">###############################</span>

<span class="c1"># pylint: disable=W0613</span>
<span class="k">def</span> <span class="nf">_checkSourceFiles</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">,</span> <span class="n">sourceFiles</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Check source files, trying to guess which ones will have encoding problems.</span>
<span class="sd">   Args:</span>
<span class="sd">      sourceDir: Local source directory</span>
<span class="sd">      sourceDir: Local source directory</span>
<span class="sd">   @raises ValueError: If a problem file is found</span>
<span class="sd">   @see U{http://opensourcehacker.com/2011/09/16/fix-linux-filename-encodings-with-python/}</span>
<span class="sd">   @see U{http://serverfault.com/questions/82821/how-to-tell-the-language-encoding-of-a-filename-on-linux}</span>
<span class="sd">   @see U{http://randysofia.com/2014/06/06/aws-cli-and-your-locale/}</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
      <span class="n">encoding</span> <span class="o">=</span> <span class="n">Diagnostics</span><span class="p">()</span><span class="o">.</span><span class="n">encoding</span>

      <span class="c1"># Note: this was difficult to fully test.  As of the original Python 2</span>
      <span class="c1"># implementation, I had a bunch of files on disk that had inconsistent</span>
      <span class="c1"># encodings, so I was able to prove that the check warned about these</span>
      <span class="c1"># files initially, and then didn&#39;t warn after I fixed them.  I didn&#39;t</span>
      <span class="c1"># save off those files for a unit test (ugh) so by the time of the Python</span>
      <span class="c1"># 3 conversion -- which is subtly different because of the different way</span>
      <span class="c1"># Python 3 handles unicode strings -- I had to contrive some tests.  I</span>
      <span class="c1"># think the tests I wrote are consistent with the earlier problems, and I</span>
      <span class="c1"># do get the same result for those tests in both CedarBackup 2 and Cedar</span>
      <span class="c1"># Backup 3.  However, I can&#39;t be certain the implementation is</span>
      <span class="c1"># equivalent.  If someone runs into a situation that this code doesn&#39;t</span>
      <span class="c1"># handle, you may need to revisit the implementation.</span>

      <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">sourceFiles</span><span class="p">:</span>
         <span class="n">path</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
         <span class="n">result</span> <span class="o">=</span> <span class="n">chardet</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
         <span class="n">source</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;encoding&quot;</span><span class="p">])</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source</span> <span class="o">!=</span> <span class="n">target</span><span class="p">:</span>
               <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Inconsistent encoding for [</span><span class="si">%s</span><span class="s2">]: got </span><span class="si">%s</span><span class="s2">, but need </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;encoding&quot;</span><span class="p">],</span> <span class="n">encoding</span><span class="p">)</span>
               <span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>
         <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Inconsistent encoding for [</span><span class="si">%s</span><span class="s2">]: got </span><span class="si">%s</span><span class="s2">, but need </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;encoding&quot;</span><span class="p">],</span> <span class="n">encoding</span><span class="p">)</span>
            <span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">failed</span><span class="p">:</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Completed checking source filename encoding (no problems found).&quot;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Some filenames have inconsistent encodings and will likely cause sync problems.&quot;</span><span class="p">)</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You may be able to fix this by setting a more sensible locale in your environment.&quot;</span><span class="p">)</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Aternately, you can rename the problem files to be valid in the indicated locale.&quot;</span><span class="p">)</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;To ignore this warning and proceed anyway, use --ignoreWarnings&quot;</span><span class="p">)</span>
         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Some filenames have inconsistent encodings and will likely cause sync problems.&quot;</span><span class="p">)</span>


<span class="c1">################################</span>
<span class="c1"># _synchronizeBucket() function</span>
<span class="c1">################################</span>

<span class="k">def</span> <span class="nf">_synchronizeBucket</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">,</span> <span class="n">s3BucketUrl</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Synchronize a local directory to an Amazon S3 bucket.</span>
<span class="sd">   Args:</span>
<span class="sd">      sourceDir: Local source directory</span>
<span class="sd">      s3BucketUrl: Target S3 bucket URL</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="c1"># Since at least early 2015, &#39;aws s3 sync&#39; is always recursive and the</span>
   <span class="c1"># --recursive option is useless.  They eventually removed it and now using</span>
   <span class="c1"># it causes an error.  See: https://github.com/aws/aws-cli/issues/1170</span>
   <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Synchronizing local source directory up to Amazon S3.&quot;</span><span class="p">)</span>
   <span class="n">args</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="s2">&quot;sync&quot;</span><span class="p">,</span> <span class="n">sourceDir</span><span class="p">,</span> <span class="n">s3BucketUrl</span><span class="p">,</span> <span class="s2">&quot;--delete&quot;</span> <span class="p">]</span>
   <span class="n">result</span> <span class="o">=</span> <span class="n">executeCommand</span><span class="p">(</span><span class="n">AWS_COMMAND</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">returnOutput</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
   <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Error [</span><span class="si">%d</span><span class="s2">] calling AWS CLI synchronize bucket.&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">###################################</span>
<span class="c1"># _verifyBucketContents() function</span>
<span class="c1">###################################</span>

<span class="k">def</span> <span class="nf">_verifyBucketContents</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">,</span> <span class="n">sourceFiles</span><span class="p">,</span> <span class="n">s3BucketUrl</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Verify that a source directory is equivalent to an Amazon S3 bucket.</span>
<span class="sd">   Args:</span>
<span class="sd">      sourceDir: Local source directory</span>
<span class="sd">      sourceFiles: Filesystem list containing contents of source directory</span>
<span class="sd">      s3BucketUrl: Target S3 bucket URL</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="c1"># As of this writing, the documentation for the S3 API that we&#39;re using</span>
   <span class="c1"># below says that up to 1000 elements at a time are returned, and that we</span>
   <span class="c1"># have to manually handle pagination by looking for the IsTruncated element.</span>
   <span class="c1"># However, in practice, this is not true.  I have been testing with</span>
   <span class="c1"># &quot;aws-cli/1.4.4 Python/2.7.3 Linux/3.2.0-4-686-pae&quot;, installed through PIP.</span>
   <span class="c1"># No matter how many items exist in my bucket and prefix, I get back a</span>
   <span class="c1"># single JSON result.  I&#39;ve tested with buckets containing nearly 6000</span>
   <span class="c1"># elements.</span>
   <span class="c1">#</span>
   <span class="c1"># If I turn on debugging, it&#39;s clear that underneath, something in the API</span>
   <span class="c1"># is executing multiple list-object requests against AWS, and stiching</span>
   <span class="c1"># results together to give me back the final JSON result.  The debug output</span>
   <span class="c1"># clearly incldues multiple requests, and each XML response (except for the</span>
   <span class="c1"># final one) contains &lt;IsTruncated&gt;true&lt;/IsTruncated&gt;.</span>
   <span class="c1">#</span>
   <span class="c1"># This feature is not mentioned in the offical changelog for any of the</span>
   <span class="c1"># releases going back to 1.0.0.  It appears to happen in the botocore</span>
   <span class="c1"># library, but I&#39;ll admit I can&#39;t actually find the code that implements it.</span>
   <span class="c1"># For now, all I can do is rely on this behavior and hope that the</span>
   <span class="c1"># documentation is out-of-date.  I&#39;m not going to write code that tries to</span>
   <span class="c1"># parse out IsTruncated if I can&#39;t actually test that code.</span>

   <span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span> <span class="o">=</span> <span class="n">s3BucketUrl</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;s3://&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

   <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;Contents[].{Key: Key, Size: Size}&quot;</span>
   <span class="n">args</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;s3api&quot;</span><span class="p">,</span> <span class="s2">&quot;list-objects&quot;</span><span class="p">,</span> <span class="s2">&quot;--bucket&quot;</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="s2">&quot;--prefix&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;--query&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="p">]</span>
   <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">=</span> <span class="n">executeCommand</span><span class="p">(</span><span class="n">AWS_COMMAND</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">returnOutput</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Error [</span><span class="si">%d</span><span class="s2">] calling AWS CLI verify bucket contents.&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span>

   <span class="n">contents</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>
   <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
      <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;Size&quot;</span><span class="p">])</span>
      <span class="n">contents</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span>

   <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>
   <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">sourceFiles</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
         <span class="n">key</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
         <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span><span class="p">)</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File was apparently not uploaded: [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
            <span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="n">contents</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
               <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File size differs [</span><span class="si">%s</span><span class="s2">]: expected </span><span class="si">%s</span><span class="s2"> bytes but got </span><span class="si">%s</span><span class="s2"> bytes&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">contents</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
               <span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>

   <span class="k">if</span> <span class="ow">not</span> <span class="n">failed</span><span class="p">:</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Completed verifying Amazon S3 bucket contents (no problems found).&quot;</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;There were differences between source directory and target S3 bucket.&quot;</span><span class="p">)</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There were differences between source directory and target S3 bucket.&quot;</span><span class="p">)</span>


<span class="c1">#########################################################################</span>
<span class="c1"># Main routine</span>
<span class="c1">########################################################################</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
   <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">cli</span><span class="p">())</span>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Cedar Backup v3  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.9.
    </div>
  </body>
</html>
